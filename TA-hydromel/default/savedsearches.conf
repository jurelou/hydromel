
[Invalid Users Failing To Authenticate From Source Using Kerberos]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4768" Status="0x6") NOT TargetUserName="*$") | eventstats dc(TargetUserName) as val by IpAddress | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Invalid Users Failing To Authenticate From Source Using Kerberos
action.summary_index.rule_description = Detects failed logins with multiple invalid domain accounts from a single source system using the Kerberos protocol.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects failed logins with multiple invalid domain accounts from a single source system using the Kerberos protocol."

[Rare Schtasks Creations]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4698") | eventstats count as val by TaskName| search val < 5 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Rare Schtasks Creations
action.summary_index.rule_description = Detects rare scheduled tasks creations that only appear a few times per time frame and could reveal password dumpers, backdoor installs or other types of malicious code

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1053
action.summary_index.attack_ID = t1053
action.summary_index.sigma_tags = car.2013-08-001
action.summary_index.sigma_tags = attack.t1053.005
action.summary_index.attack_ID = t1053.005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects rare scheduled tasks creations that only appear a few times per time frame and could reveal password dumpers, backdoor installs or other types of malicious code"

[Impacket Tool Execution]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\goldenPac*" OR Image="*\\karmaSMB*" OR Image="*\\kintercept*" OR Image="*\\ntlmrelayx*" OR Image="*\\rpcdump*" OR Image="*\\samrdump*" OR Image="*\\secretsdump*" OR Image="*\\smbexec*" OR Image="*\\smbrelayx*" OR Image="*\\wmiexec*" OR Image="*\\wmipersist*") OR (Image="*\\atexec_windows.exe" OR Image="*\\dcomexec_windows.exe" OR Image="*\\dpapi_windows.exe" OR Image="*\\findDelegation_windows.exe" OR Image="*\\GetADUsers_windows.exe" OR Image="*\\GetNPUsers_windows.exe" OR Image="*\\getPac_windows.exe" OR Image="*\\getST_windows.exe" OR Image="*\\getTGT_windows.exe" OR Image="*\\GetUserSPNs_windows.exe" OR Image="*\\ifmap_windows.exe" OR Image="*\\mimikatz_windows.exe" OR Image="*\\netview_windows.exe" OR Image="*\\nmapAnswerMachine_windows.exe" OR Image="*\\opdump_windows.exe" OR Image="*\\psexec_windows.exe" OR Image="*\\rdp_check_windows.exe" OR Image="*\\sambaPipe_windows.exe" OR Image="*\\smbclient_windows.exe" OR Image="*\\smbserver_windows.exe" OR Image="*\\sniffer_windows.exe" OR Image="*\\sniff_windows.exe" OR Image="*\\split_windows.exe" OR Image="*\\ticketer_windows.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Impacket Tool Execution
action.summary_index.rule_description = Detects the execution of different compiled Windows binaries of the impacket toolset (based on names or part of their names - could lead to false positives)

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1557.001
action.summary_index.attack_ID = t1557.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the execution of different compiled Windows binaries of the impacket toolset (based on names or part of their names - could lead to false positives)"

[CobaltStrike Service Installations in Registry]
#Global options
disabled = false
search = `windows_evtx` ((EventType="SetValue" TargetObject="*HKLM\\System\\CurrentControlSet\\Services*") ((Details="*ADMIN$*" Details="*.exe*") OR (Details="*%COMSPEC%*" Details="*start*" Details="*powershell*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CobaltStrike Service Installations in Registry
action.summary_index.rule_description = Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement. We can also catch this by system log 7045 (https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/win_cobaltstrike_service_installs.yml) In some SIEM you can catch those events also in HKLM\System\ControlSet001\Services or HKLM\System\ControlSet002\Services, however, this rule is based on a regular sysmon's events.

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002
action.summary_index.sigma_tags = attack.t1543.003
action.summary_index.attack_ID = t1543.003
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement. We can also catch this by system log 7045 (https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/win_cobaltstrike_service_installs.yml) In some SIEM you can catch those events also in HKLM\System\ControlSet001\Services or HKLM\System\ControlSet002\Services, however, this rule is based on a regular sysmon's events."

[PowerShell Download from URL]
#Global options
disabled = false
search = `windows_evtx` (Image="*\\powershell.exe" CommandLine="*new-object*" CommandLine="*net.webclient).*" CommandLine="*download*" (CommandLine="*string(*" OR CommandLine="*file(*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell Download from URL
action.summary_index.rule_description = Detects a Powershell process that contains download commands in its command line string

action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a Powershell process that contains download commands in its command line string"

[Scheduled Task Deletion]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4699") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Scheduled Task Deletion
action.summary_index.rule_description = Detects scheduled task deletion events. Scheduled tasks are likely to be deleted if not used for persistence. Malicious Software often creates tasks directly under the root node e.g. \TASKNAME

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1053
action.summary_index.attack_ID = t1053
action.summary_index.sigma_tags = car.2013-08-001
action.summary_index.sigma_tags = attack.t1053.005
action.summary_index.attack_ID = t1053.005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects scheduled task deletion events. Scheduled tasks are likely to be deleted if not used for persistence. Malicious Software often creates tasks directly under the root node e.g. \TASKNAME"

[CobaltStrike Service Installations]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4697" ((ImagePath="*ADMIN$*" ImagePath="*.exe*") OR (ImagePath="*%COMSPEC%*" ImagePath="*start*" ImagePath="*powershell*") OR ImagePath="*powershell -nop -w hidden -encodedcommand*" OR (ImagePath="*SUVYIChOZXctT2JqZWN0IE5ldC5XZWJjbGllbnQpLkRvd25sb2FkU3RyaW5nKCdodHRwOi8vMTI3LjAuMC4xO*" OR ImagePath="*lFWCAoTmV3LU9iamVjdCBOZXQuV2ViY2xpZW50KS5Eb3dubG9hZFN0cmluZygnaHR0cDovLzEyNy4wLjAuMT*" OR ImagePath="*JRVggKE5ldy1PYmplY3QgTmV0LldlYmNsaWVudCkuRG93bmxvYWRTdHJpbmcoJ2h0dHA6Ly8xMjcuMC4wLjE6*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CobaltStrike Service Installations
action.summary_index.rule_description = Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002
action.summary_index.sigma_tags = attack.t1543.003
action.summary_index.attack_ID = t1543.003
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement"

[Suspicious PsExec Execution]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="5145" ShareName="\\*\\IPC$" (RelativeTargetName="*-stdin" OR RelativeTargetName="*-stdout" OR RelativeTargetName="*-stderr")) NOT (EventCode="5145" ShareName="\\*\\IPC$" RelativeTargetName="PSEXESVC*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PsExec Execution
action.summary_index.rule_description = detects execution of psexec or paexec with renamed service name, this rule helps to filter out the noise if psexec is used for legit purposes or if attacker uses a different psexec client other than sysinternal one

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1077
action.summary_index.attack_ID = t1077
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "detects execution of psexec or paexec with renamed service name, this rule helps to filter out the noise if psexec is used for legit purposes or if attacker uses a different psexec client other than sysinternal one"

[WMI Spawning Windows PowerShell]
#Global options
disabled = false
search = `windows_evtx` ((((ParentImage="*\\wmiprvse.exe") (Image="*\\powershell.exe")) NOT CommandLine="null") NOT NOT CommandLine="*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = WMI Spawning Windows PowerShell
action.summary_index.rule_description = Detects WMI spawning PowerShell

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1064
action.summary_index.attack_ID = t1064

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects WMI spawning PowerShell"

[Suspect Svchost Activity]
#Global options
disabled = false
search = `windows_evtx` ((CommandLine="*svchost.exe" Image="*\\svchost.exe") NOT ((ParentImage="*\\rpcnet.exe" OR ParentImage="*\\rpcnetp.exe") OR NOT CommandLine="*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspect Svchost Activity
action.summary_index.rule_description = It is extremely abnormal for svchost.exe to spawn without any CLI arguments and is normally observed when a malicious process spawns the process and injects code into the process memory space.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1055
action.summary_index.attack_ID = t1055

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "It is extremely abnormal for svchost.exe to spawn without any CLI arguments and is normally observed when a malicious process spawns the process and injects code into the process memory space."

[Suspicious Word Cab File Write CVE-2021-40444]
#Global options
disabled = false
search = `windows_evtx` (Image="\\winword.exe" ((TargetFilename="*.cab" TargetFilename="*\\Windows\\INetCache*") OR (TargetFilename="*\\AppData\\Local\\Temp\\*" TargetFilename="*.inf*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Word Cab File Write CVE-2021-40444
action.summary_index.rule_description = Detects file creation patterns noticeable during the exploitation of CVE-2021-40444


#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects file creation patterns noticeable during the exploitation of CVE-2021-40444"

[Mimikatz Detection LSASS Access]
#Global options
disabled = false
search = `windows_evtx` (Channel="Microsoft-Windows-Sysmon/Operational" EventCode="10" TargetImage="C:\\windows\\system32\\lsass.exe" GrantedAccess="0x1410") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Mimikatz Detection LSASS Access
action.summary_index.rule_description = Detects process access to LSASS which is typical for Mimikatz (0x1000 PROCESS_QUERY_ LIMITED_INFORMATION, 0x0400 PROCESS_QUERY_ INFORMATION, 0x0010 PROCESS_VM_READ)

action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.s0002
action.summary_index.sigma_tags = attack.credential_access

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects process access to LSASS which is typical for Mimikatz (0x1000 PROCESS_QUERY_ LIMITED_INFORMATION, 0x0400 PROCESS_QUERY_ INFORMATION, 0x0010 PROCESS_VM_READ)"

[Suspicious Remote Thread Created]
#Global options
disabled = false
search = `windows_evtx` ((SourceImage="*\\bash.exe" OR SourceImage="*\\cvtres.exe" OR SourceImage="*\\defrag.exe" OR SourceImage="*\\dnx.exe" OR SourceImage="*\\esentutl.exe" OR SourceImage="*\\excel.exe" OR SourceImage="*\\expand.exe" OR SourceImage="*\\explorer.exe" OR SourceImage="*\\find.exe" OR SourceImage="*\\findstr.exe" OR SourceImage="*\\forfiles.exe" OR SourceImage="*\\git.exe" OR SourceImage="*\\gpupdate.exe" OR SourceImage="*\\hh.exe" OR SourceImage="*\\iexplore.exe" OR SourceImage="*\\installutil.exe" OR SourceImage="*\\lync.exe" OR SourceImage="*\\makecab.exe" OR SourceImage="*\\mDNSResponder.exe" OR SourceImage="*\\monitoringhost.exe" OR SourceImage="*\\msbuild.exe" OR SourceImage="*\\mshta.exe" OR SourceImage="*\\msiexec.exe" OR SourceImage="*\\mspaint.exe" OR SourceImage="*\\outlook.exe" OR SourceImage="*\\ping.exe" OR SourceImage="*\\powerpnt.exe" OR SourceImage="*\\powershell.exe" OR SourceImage="*\\provtool.exe" OR SourceImage="*\\python.exe" OR SourceImage="*\\regsvr32.exe" OR SourceImage="*\\robocopy.exe" OR SourceImage="*\\runonce.exe" OR SourceImage="*\\sapcimc.exe" OR SourceImage="*\\schtasks.exe" OR SourceImage="*\\smartscreen.exe" OR SourceImage="*\\spoolsv.exe" OR SourceImage="*\\tstheme.exe" OR SourceImage="*\\userinit.exe" OR SourceImage="*\\vssadmin.exe" OR SourceImage="*\\vssvc.exe" OR SourceImage="*\\w3wp.exe" OR SourceImage="*\\winlogon.exe" OR SourceImage="*\\winscp.exe" OR SourceImage="*\\wmic.exe" OR SourceImage="*\\word.exe" OR SourceImage="*\\wscript.exe") NOT SourceImage="*Visual Studio*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Remote Thread Created
action.summary_index.rule_description = Offensive tradecraft is switching away from using APIs like "CreateRemoteThread", however, this is still largely observed in the wild. This rule aims to detect suspicious processes (those we would not expect to behave in this way like word.exe or outlook.exe) creating remote threads on other processes. It is a generalistic rule, but it should have a low FP ratio due to the selected range of processes.

action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1055
action.summary_index.attack_ID = t1055

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Offensive tradecraft is switching away from using APIs like "CreateRemoteThread", however, this is still largely observed in the wild. This rule aims to detect suspicious processes (those we would not expect to behave in this way like word.exe or outlook.exe) creating remote threads on other processes. It is a generalistic rule, but it should have a low FP ratio due to the selected range of processes."

[Credential Dumping by LaZagne]
#Global options
disabled = false
search = `windows_evtx` (TargetImage="*\\lsass.exe" CallTrace="*C:\\Windows\\SYSTEM32\\ntdll.dll+*" CallTrace="*|C:\\Windows\\System32\\KERNELBASE.dll+*" CallTrace="*_ctypes.pyd+*" CallTrace="*python27.dll+*" GrantedAccess="0x1FFFFF") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Credential Dumping by LaZagne
action.summary_index.rule_description = Detects LSASS process access by LaZagne for credential dumping.

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001
action.summary_index.sigma_tags = attack.s0349

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects LSASS process access by LaZagne for credential dumping."

[Suspicious Rejected SMB Guest Logon From IP]
#Global options
disabled = false
search = `windows_evtx` (Channel="Microsoft-Windows-SmbClient/Security" EventCode="31017" Description="*Rejected an insecure guest logon*" UserName="" ServerName="\\1*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Rejected SMB Guest Logon From IP
action.summary_index.rule_description = Detect Attempt PrintNightmare (CVE-2021-1675) Remote code execution in Windows Spooler Service

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1110.001
action.summary_index.attack_ID = t1110.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detect Attempt PrintNightmare (CVE-2021-1675) Remote code execution in Windows Spooler Service"

[External Disk Drive Or USB Storage Device]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" ((EventCode="6416" ClassName="DiskDrive") OR DeviceDescription="USB Mass Storage Device")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = External Disk Drive Or USB Storage Device
action.summary_index.rule_description = Detects external diskdrives or plugged in USB devices , EventID 6416 on windows 10 or later

action.summary_index.sigma_tags = attack.t1091
action.summary_index.attack_ID = t1091
action.summary_index.sigma_tags = attack.t1200
action.summary_index.attack_ID = t1200
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.initial_access

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects external diskdrives or plugged in USB devices , EventID 6416 on windows 10 or later"

[Credential Dumping Tools Service Execution]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4697" (ImagePath="*fgexec*" OR ImagePath="*dumpsvc*" OR ImagePath="*cachedump*" OR ImagePath="*mimidrv*" OR ImagePath="*gsecdump*" OR ImagePath="*servpw*" OR ImagePath="*pwdump*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Credential Dumping Tools Service Execution
action.summary_index.rule_description = Detects well-known credential dumping tools execution via service execution events

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001
action.summary_index.sigma_tags = attack.t1003.002
action.summary_index.attack_ID = t1003.002
action.summary_index.sigma_tags = attack.t1003.004
action.summary_index.attack_ID = t1003.004
action.summary_index.sigma_tags = attack.t1003.005
action.summary_index.attack_ID = t1003.005
action.summary_index.sigma_tags = attack.t1003.006
action.summary_index.attack_ID = t1003.006
action.summary_index.sigma_tags = attack.t1035
action.summary_index.attack_ID = t1035
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002
action.summary_index.sigma_tags = attack.s0005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects well-known credential dumping tools execution via service execution events"

[Multiple Users Attempting To Authenticate Using Explicit Credentials]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4648") | eventstats dc(Account_Name) as val by Computer | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Multiple Users Attempting To Authenticate Using Explicit Credentials
action.summary_index.rule_description = Detects a source user failing to authenticate with multiple users using explicit credentials on a host.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a source user failing to authenticate with multiple users using explicit credentials on a host."

[SMB Create Remote File Admin Share]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="5145" ShareName="*C$" AccessMask="0x2") NOT SubjectUserName="*$") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = SMB Create Remote File Admin Share
action.summary_index.rule_description = Look for non-system accounts SMB accessing a file with write (0x2) access mask via administrative share (i.e C$).

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Look for non-system accounts SMB accessing a file with write (0x2) access mask via administrative share (i.e C$)."

[New RUN Key Pointing to Suspicious Folder]
#Global options
disabled = false
search = `windows_evtx` ((TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\*" OR TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*") ((Details="*C:\\Windows\\Temp\\*" OR Details="*C:\\$Recycle.bin\\*" OR Details="*C:\\Temp\\*" OR Details="*C:\\Users\\Public\\*" OR Details="*C:\\Users\\Default\\*" OR Details="*C:\\Users\\Desktop\\*" OR Details="*\\AppData\\Local\\Temp\\*") OR (Details="%Public%\\*" OR Details="wscript*" OR Details="cscript*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = New RUN Key Pointing to Suspicious Folder
action.summary_index.rule_description = Detects suspicious new RUN key element pointing to an executable in a suspicious folder

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1060
action.summary_index.attack_ID = t1060
action.summary_index.sigma_tags = attack.t1547.001
action.summary_index.attack_ID = t1547.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious new RUN key element pointing to an executable in a suspicious folder"

[Procdump Usage]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\procdump.exe" OR Image="*\\procdump64.exe") OR (CommandLine="* -ma *" CommandLine="*.exe*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Procdump Usage
action.summary_index.rule_description = Detects uses of the SysInternals Procdump utility

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1036
action.summary_index.attack_ID = t1036
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects uses of the SysInternals Procdump utility"

[Proxy Execution Via Explorer.exe]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\explorer.exe") (ParentImage="*\\cmd.exe") (CommandLine="*explorer.exe*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Proxy Execution Via Explorer.exe
action.summary_index.rule_description = Attackers can use explorer.exe for evading defense mechanisms

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1218
action.summary_index.attack_ID = t1218

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Attackers can use explorer.exe for evading defense mechanisms"

[Direct Syscall of NtOpenProcess]
#Global options
disabled = false
search = `windows_evtx` CallTrace="UNKNOWN*" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Direct Syscall of NtOpenProcess
action.summary_index.rule_description = Detects the usage of the direct syscall of NtOpenProcess which might be done from a CobaltStrike BOF.

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1106
action.summary_index.attack_ID = t1106

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the usage of the direct syscall of NtOpenProcess which might be done from a CobaltStrike BOF."

[SVCHOST Credential Dump]
#Global options
disabled = false
search = `windows_evtx` ((TargetImage="*\\svchost.exe" GrantedAccess="0x143a") NOT (SourceImage="*\\services.exe" OR SourceImage="*\\msiexec.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = SVCHOST Credential Dump
action.summary_index.rule_description = Detects when a process, such as mimikatz, accesses the memory of svchost to dump credentials

action.summary_index.sigma_tags = attack.t1548
action.summary_index.attack_ID = t1548

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects when a process, such as mimikatz, accesses the memory of svchost to dump credentials"

[Zip A Folder With PowerShell For Staging In Temp]
#Global options
disabled = false
search = `windows_evtx` (ContextInfo="*Compress-Archive *" ContextInfo="* -Path *" ContextInfo="* -DestinationPath *" ContextInfo="*$env:TEMP\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Zip A Folder With PowerShell For Staging In Temp
action.summary_index.rule_description = Use living off the land tools to zip a file and stage it in the Windows temporary folder for later exfiltration

action.summary_index.sigma_tags = attack.collection
action.summary_index.sigma_tags = attack.t1074.001
action.summary_index.attack_ID = t1074.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Use living off the land tools to zip a file and stage it in the Windows temporary folder for later exfiltration"

[Windows Defender Threat Detection Disabled]
#Global options
disabled = false
search = `windows_evtx` (EventCode="5001" OR EventCode="5010" OR EventCode="5012" OR EventCode="5101") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Defender Threat Detection Disabled
action.summary_index.rule_description = Detects disabling Windows Defender threat protection

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1089
action.summary_index.attack_ID = t1089
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects disabling Windows Defender threat protection"

[Reg Add RUN Key]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*reg*" CommandLine="* ADD *" CommandLine="*Software\\Microsoft\\Windows\\CurrentVersion\\Run*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Reg Add RUN Key
action.summary_index.rule_description = Detects suspicious command line reg.exe tool adding key to RUN key in Registry

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1547.001
action.summary_index.attack_ID = t1547.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious command line reg.exe tool adding key to RUN key in Registry"

[PowerShell Get-Process LSASS in ScriptBlock]
#Global options
disabled = false
search = `windows_evtx` ScriptBlockText="*Get-Process lsass*" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell Get-Process LSASS in ScriptBlock
action.summary_index.rule_description = Detects a Get-Process command on lsass process, which is in almost all cases a sign of malicious activity

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a Get-Process command on lsass process, which is in almost all cases a sign of malicious activity"

[Locked Workstation]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4800")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Locked Workstation
action.summary_index.rule_description = Automatically lock workstation sessions after a standard period of inactivity. The case is not applicable for Unix OS. Supported OS - Windows 2008 R2 and 7, Windows 2012 R2 and 8.1, Windows 2016 and 10 Windows Server 2019.


#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Automatically lock workstation sessions after a standard period of inactivity. The case is not applicable for Unix OS. Supported OS - Windows 2008 R2 and 7, Windows 2012 R2 and 8.1, Windows 2016 and 10 Windows Server 2019."

[New Service Creation]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\sc.exe" CommandLine="*create*" CommandLine="*binpath*") OR (Image="*\\powershell.exe" CommandLine="*new-service*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = New Service Creation
action.summary_index.rule_description = Detects creation of a new service.

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1050
action.summary_index.attack_ID = t1050
action.summary_index.sigma_tags = attack.t1543.003
action.summary_index.attack_ID = t1543.003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects creation of a new service."

[Failed Logins with Different Accounts from Single Source System]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="529" OR EventCode="4625") TargetUserName="*" WorkstationName="*") | eventstats dc(TargetUserName) as val by WorkstationName | search val > 3 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Failed Logins with Different Accounts from Single Source System
action.summary_index.rule_description = Detects suspicious failed logins with different user accounts from a single source system

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1078
action.summary_index.attack_ID = t1078

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious failed logins with different user accounts from a single source system"

[Interactive Logon to Server Systems]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" ((EventCode="528" OR EventCode="529" OR EventCode="4624" OR EventCode="4625") LogonType="2" (Computer="%ServerSystems%" OR Computer="%DomainControllers%")) NOT (LogonProcessName="Advapi" Computer="%Workstations%")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Interactive Logon to Server Systems
action.summary_index.rule_description = Detects interactive console logons to Server Systems

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1078
action.summary_index.attack_ID = t1078

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects interactive console logons to Server Systems"

[Usage of Sysinternals Tools]
#Global options
disabled = false
search = `windows_evtx` TargetObject="*\\EulaAccepted" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Usage of Sysinternals Tools
action.summary_index.rule_description = Detects the usage of Sysinternals Tools due to accepteula key being added to Registry

action.summary_index.sigma_tags = attack.resource_development
action.summary_index.sigma_tags = attack.t1588.002
action.summary_index.attack_ID = t1588.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the usage of Sysinternals Tools due to accepteula key being added to Registry"

[Suspicious PowerShell Keywords]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*System.Reflection.Assembly.Load($*" OR ScriptBlockText="*[System.Reflection.Assembly]::Load($*" OR ScriptBlockText="*[Reflection.Assembly]::Load($*" OR ScriptBlockText="*System.Reflection.AssemblyName*" OR ScriptBlockText="*Reflection.Emit.AssemblyBuilderAccess*" OR ScriptBlockText="*Runtime.InteropServices.DllImportAttribute*" OR ScriptBlockText="*SuspendThread*" OR ScriptBlockText="*rundll32*" OR ScriptBlockText="*Invoke-WMIMethod*" OR ScriptBlockText="*http://127.0.0.1*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Keywords
action.summary_index.rule_description = Detects keywords that could indicate the use of some PowerShell exploitation framework

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects keywords that could indicate the use of some PowerShell exploitation framework"

[RDP Login from Localhost]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4624" LogonType="10" (IpAddress="::1" OR IpAddress="127.0.0.1")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = RDP Login from Localhost
action.summary_index.rule_description = RDP login with localhost source address may be a tunnelled login

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1076
action.summary_index.attack_ID = t1076
action.summary_index.sigma_tags = car.2013-07-002
action.summary_index.sigma_tags = attack.t1021.001
action.summary_index.attack_ID = t1021.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "RDP login with localhost source address may be a tunnelled login"

[New Application in AppCompat]
#Global options
disabled = false
search = `windows_evtx` TargetObject="*\\AppCompatFlags\\Compatibility Assistant\\Store\\*" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = New Application in AppCompat
action.summary_index.rule_description = A General detection for a new application in AppCompat. This indicates an application executing for the first time on an endpoint.

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1204.002
action.summary_index.attack_ID = t1204.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "A General detection for a new application in AppCompat. This indicates an application executing for the first time on an endpoint."

[Delete Volume Shadow Copies Via WMI With PowerShell]
#Global options
disabled = false
search = `windows_evtx` (HostApplication="*Get-WmiObject*" HostApplication="* Win32_Shadowcopy*" (HostApplication="*Delete()*" OR HostApplication="*Remove-WmiObject*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Delete Volume Shadow Copies Via WMI With PowerShell
action.summary_index.rule_description = Shadow Copies deletion using operating systems utilities via PowerShell

action.summary_index.sigma_tags = attack.impact
action.summary_index.sigma_tags = attack.t1490
action.summary_index.attack_ID = t1490

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Shadow Copies deletion using operating systems utilities via PowerShell"

[Zip A Folder With PowerShell For Staging In Temp]
#Global options
disabled = false
search = `windows_evtx` (Channel="Windows PowerShell" HostApplication="*Compress-Archive *" HostApplication="* -Path *" HostApplication="* -DestinationPath *" HostApplication="*$env:TEMP\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Zip A Folder With PowerShell For Staging In Temp
action.summary_index.rule_description = Use living off the land tools to zip a file and stage it in the Windows temporary folder for later exfiltration

action.summary_index.sigma_tags = attack.collection
action.summary_index.sigma_tags = attack.t1074.001
action.summary_index.attack_ID = t1074.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Use living off the land tools to zip a file and stage it in the Windows temporary folder for later exfiltration"

[Group Modification Logging]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4728" OR EventCode="4729" OR EventCode="4730" OR EventCode="633" OR EventCode="632" OR EventCode="634")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Group Modification Logging
action.summary_index.rule_description = Configure systems to issue a log entry and alert when an account is added to or removed from any group assigned administrative privileges. Sigma detects Event ID 4728 indicates a Member is added to a Security Group. Event ID 4729 indicates a Member is removed from a Security enabled-group. Event ID 4730 indicates aSecurity Group is deleted. The case is not applicable for Unix OS. Supported OS - Windows 2008 R2 and 7, Windows 2012 R2 and 8.1, Windows 2016 and 10 Windows Server 2019, Windows Server 2000, Windows 2003 and XP.


#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Configure systems to issue a log entry and alert when an account is added to or removed from any group assigned administrative privileges. Sigma detects Event ID 4728 indicates a Member is added to a Security Group. Event ID 4729 indicates a Member is removed from a Security enabled-group. Event ID 4730 indicates aSecurity Group is deleted. The case is not applicable for Unix OS. Supported OS - Windows 2008 R2 and 7, Windows 2012 R2 and 8.1, Windows 2016 and 10 Windows Server 2019, Windows Server 2000, Windows 2003 and XP."

[LDAP Reconnaissance / Active Directory Enumeration]
#Global options
disabled = false
search = `windows_evtx` (((EventCode="30" (SearchFilter="*(groupType:1.2.840.113556.1.4.803:=2147483648)*" OR SearchFilter="*(groupType:1.2.840.113556.1.4.803:=2147483656)*" OR SearchFilter="*(groupType:1.2.840.113556.1.4.803:=2147483652)*" OR SearchFilter="*(groupType:1.2.840.113556.1.4.803:=2147483650)*" OR SearchFilter="*(sAMAccountType=805306369)*" OR SearchFilter="*(sAMAccountType=805306368)*" OR SearchFilter="*(sAMAccountType=536870913)*" OR SearchFilter="*(sAMAccountType=536870912)*" OR SearchFilter="*(sAMAccountType=268435457)*" OR SearchFilter="*(sAMAccountType=268435456)*" OR SearchFilter="*(objectCategory=groupPolicyContainer)*" OR SearchFilter="*(objectCategory=organizationalUnit)*" OR SearchFilter="*(objectCategory=Computer)*" OR SearchFilter="*(objectCategory=nTDSDSA)*" OR SearchFilter="*(objectCategory=server)*" OR SearchFilter="*(objectCategory=domain)*" OR SearchFilter="*(objectCategory=person)*" OR SearchFilter="*(objectCategory=group)*" OR SearchFilter="*(objectCategory=user)*" OR SearchFilter="*(objectClass=trustedDomain)*" OR SearchFilter="*(objectClass=computer)*" OR SearchFilter="*(objectClass=server)*" OR SearchFilter="*(objectClass=group)*" OR SearchFilter="*(objectClass=user)*" OR SearchFilter="*(primaryGroupID=521)*" OR SearchFilter="*(primaryGroupID=516)*" OR SearchFilter="*(primaryGroupID=515)*" OR SearchFilter="*(primaryGroupID=512)*" OR SearchFilter="*Domain Admins*")) NOT (EventCode="30" (SearchFilter="*(domainSid=*)*" OR SearchFilter="*(objectSid=*)*"))) OR (EventCode="30" (SearchFilter="*(userAccountControl:1.2.840.113556.1.4.803:=4194304)*" OR SearchFilter="*(userAccountControl:1.2.840.113556.1.4.803:=2097152)*" OR SearchFilter="*!(userAccountControl:1.2.840.113556.1.4.803:=1048574)*" OR SearchFilter="*(userAccountControl:1.2.840.113556.1.4.803:=524288)*" OR SearchFilter="*(userAccountControl:1.2.840.113556.1.4.803:=65536)*" OR SearchFilter="*(userAccountControl:1.2.840.113556.1.4.803:=8192)*" OR SearchFilter="*(userAccountControl:1.2.840.113556.1.4.803:=544)*" OR SearchFilter="*!(UserAccountControl:1.2.840.113556.1.4.803:=2)*" OR SearchFilter="*msDS-AllowedToActOnBehalfOfOtherIdentity*" OR SearchFilter="*msDS-AllowedToDelegateTo*" OR SearchFilter="*(accountExpires=9223372036854775807)*" OR SearchFilter="*(accountExpires=0)*" OR SearchFilter="*(adminCount=1)*" OR SearchFilter="*ms-MCS-AdmPwd*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = LDAP Reconnaissance / Active Directory Enumeration
action.summary_index.rule_description = Detects possible Active Directory enumeration via LDAP

action.summary_index.sigma_tags = attack.discovery
action.summary_index.sigma_tags = attack.t1069.002
action.summary_index.attack_ID = t1069.002
action.summary_index.sigma_tags = attack.t1087.002
action.summary_index.attack_ID = t1087.002
action.summary_index.sigma_tags = attack.t1482
action.summary_index.attack_ID = t1482

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects possible Active Directory enumeration via LDAP"

[Execute From Alternate Data Streams]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*txt:*" ((CommandLine="*type *" CommandLine="* > *") OR (CommandLine="*makecab *" CommandLine="*.cab*") OR (CommandLine="*reg *" CommandLine="* export *") OR (CommandLine="*regedit *" CommandLine="* /E *") OR (CommandLine="*esentutl *" CommandLine="* /y *" CommandLine="* /d *" CommandLine="* /o *"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Execute From Alternate Data Streams
action.summary_index.rule_description = Adversaries may use NTFS file attributes to hide their malicious data in order to evade detection

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1564.004
action.summary_index.attack_ID = t1564.004

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Adversaries may use NTFS file attributes to hide their malicious data in order to evade detection"

[Grabbing Sensitive Hives via Reg Utility]
#Global options
disabled = false
search = `windows_evtx` (Image="*\\reg.exe" (CommandLine="*save*" OR CommandLine="*export*" OR CommandLine="*ave*" OR CommandLine="*eport*") (CommandLine="*hklm*" OR CommandLine="*hkm*" OR CommandLine="*hkey_local_machine*" OR CommandLine="*hkey_ocal_machine*" OR CommandLine="*hkey_loca_machine*" OR CommandLine="*hkey_oca_machine*") (CommandLine="*\\system" OR CommandLine="*\\sam" OR CommandLine="*\\security" OR CommandLine="*\\ystem" OR CommandLine="*\\sytem" OR CommandLine="*\\ytem" OR CommandLine="*\\am" OR CommandLine="*\\ecurity")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Grabbing Sensitive Hives via Reg Utility
action.summary_index.rule_description = Dump sam, system or security hives using REG.exe utility

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.002
action.summary_index.attack_ID = t1003.002
action.summary_index.sigma_tags = attack.t1003.004
action.summary_index.attack_ID = t1003.004
action.summary_index.sigma_tags = attack.t1003.005
action.summary_index.attack_ID = t1003.005
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = car.2013-07-001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Dump sam, system or security hives using REG.exe utility"

[Suspicious Eventlog Clear or Configuration Using Wevtutil]
#Global options
disabled = false
search = `windows_evtx` (((Image="*\\powershell.exe" (CommandLine="*Clear-EventLog*" OR CommandLine="*Remove-EventLog*" OR CommandLine="*Limit-EventLog*")) OR (Image="*\\wmic.exe" CommandLine="* ClearEventLog *")) OR (Image="*\\wevtutil.exe" (CommandLine="*clear-log*" OR CommandLine="* cl *" OR CommandLine="*set-log*" OR CommandLine="* sl *"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Eventlog Clear or Configuration Using Wevtutil
action.summary_index.rule_description = Detects clearing or configuration of eventlogs using wevtutil, powershell and wmic. Might be used by ransomwares during the attack (seen by NotPetya and others).

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1070.001
action.summary_index.attack_ID = t1070.001
action.summary_index.sigma_tags = attack.t1070
action.summary_index.attack_ID = t1070
action.summary_index.sigma_tags = car.2016-04-002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects clearing or configuration of eventlogs using wevtutil, powershell and wmic. Might be used by ransomwares during the attack (seen by NotPetya and others)."

[Change PowerShell Policies to a Unsecure Level]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*Set-ExecutionPolicy*" (ScriptBlockText="*Unrestricted*" OR ScriptBlockText="*bypass*" OR ScriptBlockText="*RemoteSigned*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Change PowerShell Policies to a Unsecure Level
action.summary_index.rule_description = Detects use of Set-ExecutionPolicy to set a unsecure policies

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects use of Set-ExecutionPolicy to set a unsecure policies"

[Windows Processes Suspicious Parent Directory]
#Global options
disabled = false
search = `windows_evtx` ((((Image="*\\svchost.exe" OR Image="*\\taskhost.exe" OR Image="*\\lsm.exe" OR Image="*\\lsass.exe" OR Image="*\\services.exe" OR Image="*\\lsaiso.exe" OR Image="*\\csrss.exe" OR Image="*\\wininit.exe" OR Image="*\\winlogon.exe") NOT (ParentImage="*\\SavService.exe" OR (ParentImage="*\\System32\\*" OR ParentImage="*\\SysWOW64\\*"))) NOT ((ParentImage="*\\Windows Defender\\*" OR ParentImage="*\\Microsoft Security Client\\*") ParentImage="*\\MsMpEng.exe")) NOT NOT ParentImage="*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Processes Suspicious Parent Directory
action.summary_index.rule_description = Detect suspicious parent processes of well-known Windows processes

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1036
action.summary_index.attack_ID = t1036
action.summary_index.sigma_tags = attack.t1036.003
action.summary_index.attack_ID = t1036.003
action.summary_index.sigma_tags = attack.t1036.005
action.summary_index.attack_ID = t1036.005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detect suspicious parent processes of well-known Windows processes"

[Suspicious PowerShell Invocations - Specific]
#Global options
disabled = false
search = `windows_evtx` ((ContextInfo="*-nop*" ContextInfo="* -w *" ContextInfo="*hidden*" ContextInfo="* -c *" ContextInfo="*[Convert]::FromBase64String*") OR (ContextInfo="* -w *" ContextInfo="*hidden*" ContextInfo="*-noni*" ContextInfo="*-nop*" ContextInfo="* -c *" ContextInfo="*iex*" ContextInfo="*New-Object*") OR (ContextInfo="* -w *" ContextInfo="*hidden*" ContextInfo="*-ep*" ContextInfo="*bypass*" ContextInfo="*-Enc*") OR (ContextInfo="*powershell*" ContextInfo="*reg*" ContextInfo="*add*" ContextInfo="*HKCU\\software\\microsoft\\windows\\currentversion\\run*") OR (ContextInfo="*bypass*" ContextInfo="*-noprofile*" ContextInfo="*-windowstyle*" ContextInfo="*hidden*" ContextInfo="*new-object*" ContextInfo="*system.net.webclient*" ContextInfo="*.download*") OR (ContextInfo="*iex*" ContextInfo="*New-Object*" ContextInfo="*Net.WebClient*" ContextInfo="*.Download*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Invocations - Specific
action.summary_index.rule_description = Detects suspicious PowerShell invocation command parameters

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell invocation command parameters"

[Suspicious PowerShell Invocations - Generic]
#Global options
disabled = false
search = `windows_evtx` ((ContextInfo="* -enc *" OR ContextInfo="* -EncodedCommand *") (ContextInfo="* -w hidden *" OR ContextInfo="* -window hidden *" OR ContextInfo="* -windowstyle hidden *") (ContextInfo="* -noni *" OR ContextInfo="* -noninteractive *")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Invocations - Generic
action.summary_index.rule_description = Detects suspicious PowerShell invocation command parameters

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell invocation command parameters"

[AD User Enumeration]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4662" ObjectType="*bf967aba-0de6-11d0-a285-00aa003049e2*") NOT (SubjectUserName="*$" OR SubjectUserName="MSOL_*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = AD User Enumeration
action.summary_index.rule_description = Detects access to a domain user from a non-machine account

action.summary_index.sigma_tags = attack.discovery
action.summary_index.sigma_tags = attack.t1087
action.summary_index.attack_ID = t1087
action.summary_index.sigma_tags = attack.t1087.002
action.summary_index.attack_ID = t1087.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects access to a domain user from a non-machine account"

[Powershell WMI Persistence]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*New-CimInstance *" ScriptBlockText="*-Namespace root/subscription *" ScriptBlockText="*-Property *" (ScriptBlockText="*-ClassName __EventFilter *" OR ScriptBlockText="*-ClassName CommandLineEventConsumer *")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Powershell WMI Persistence
action.summary_index.rule_description = Adversaries may establish persistence and elevate privileges by executing malicious content triggered by a Windows Management Instrumentation (WMI) event subscription.

action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1546.003
action.summary_index.attack_ID = t1546.003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Adversaries may establish persistence and elevate privileges by executing malicious content triggered by a Windows Management Instrumentation (WMI) event subscription."

[CobaltStrike BOF Injection Pattern]
#Global options
disabled = false
search = `windows_evtx` (CallTrace="C:\\\\Windows\\\\SYSTEM32\\\\ntdll\\.dll\*C:\\\\Windows\\\\System32\\\\KERNELBASE\\.dll\*UNKNOWN*" (GrantedAccess="0x1028" OR GrantedAccess="0x1fffff")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CobaltStrike BOF Injection Pattern
action.summary_index.rule_description = Detects a typical pattern of a CobaltStrike BOF which inject into other processes

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1106
action.summary_index.attack_ID = t1106
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a typical pattern of a CobaltStrike BOF which inject into other processes"

[CobaltStrike Service Installations]
#Global options
disabled = false
search = `windows_evtx` (Channel="System" EventCode="7045" ((ImagePath="*ADMIN$*" ImagePath="*.exe*") OR (ImagePath="*%COMSPEC%*" ImagePath="*start*" ImagePath="*powershell*") OR ImagePath="*powershell -nop -w hidden -encodedcommand*" OR (ImagePath="*SUVYIChOZXctT2JqZWN0IE5ldC5XZWJjbGllbnQpLkRvd25sb2FkU3RyaW5nKCdodHRwOi8vMTI3LjAuMC4xO*" OR ImagePath="*lFWCAoTmV3LU9iamVjdCBOZXQuV2ViY2xpZW50KS5Eb3dubG9hZFN0cmluZygnaHR0cDovLzEyNy4wLjAuMT*" OR ImagePath="*JRVggKE5ldy1PYmplY3QgTmV0LldlYmNsaWVudCkuRG93bmxvYWRTdHJpbmcoJ2h0dHA6Ly8xMjcuMC4wLjE6*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CobaltStrike Service Installations
action.summary_index.rule_description = Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002
action.summary_index.sigma_tags = attack.t1543.003
action.summary_index.attack_ID = t1543.003
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement"

[Registry Persistence Mechanism via Windows Telemetry]
#Global options
disabled = false
search = `windows_evtx` ((TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\TelemetryController\\*" TargetObject="*\\Command*" Details="*.exe*") NOT (Details="*\\system32\\CompatTelRunner.exe*" OR Details="*\\system32\\DeviceCensus.exe*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Registry Persistence Mechanism via Windows Telemetry
action.summary_index.rule_description = Detects persistence method using windows telemetry

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1053.005
action.summary_index.attack_ID = t1053.005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects persistence method using windows telemetry"

[Credentials Dumping Tools Accessing LSASS Memory]
#Global options
disabled = false
search = `windows_evtx` ((TargetImage="*\\lsass.exe" (GrantedAccess="*0x40*" OR GrantedAccess="*0x1000*" OR GrantedAccess="*0x1400*" OR GrantedAccess="*0x100000*" OR GrantedAccess="*0x1410*" OR GrantedAccess="*0x1010*" OR GrantedAccess="*0x1438*" OR GrantedAccess="*0x143a*" OR GrantedAccess="*0x1418*" OR GrantedAccess="*0x1f0fff*" OR GrantedAccess="*0x1f1fff*" OR GrantedAccess="*0x1f2fff*" OR GrantedAccess="*0x1f3fff*")) NOT (SourceImage="*\\wmiprvse.exe" OR SourceImage="*\\taskmgr.exe" OR SourceImage="*\\procexp64.exe" OR SourceImage="*\\procexp.exe" OR SourceImage="*\\lsm.exe" OR SourceImage="*\\MsMpEng.exe" OR SourceImage="*\\csrss.exe" OR SourceImage="*\\wininit.exe" OR SourceImage="*\\vmtoolsd.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Credentials Dumping Tools Accessing LSASS Memory
action.summary_index.rule_description = Detects process access LSASS memory which is typical for credentials dumping tools

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.s0002
action.summary_index.sigma_tags = car.2019-04-004

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects process access LSASS memory which is typical for credentials dumping tools"

[Mimikatz through Windows Remote Management]
#Global options
disabled = false
search = `windows_evtx` (TargetImage="*\\lsass.exe" SourceImage="C:\\Windows\\system32\\wsmprovhost.exe") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Mimikatz through Windows Remote Management
action.summary_index.rule_description = Detects usage of mimikatz through WinRM protocol by monitoring access to lsass process by wsmprovhost.exe.

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.006
action.summary_index.attack_ID = t1021.006
action.summary_index.sigma_tags = attack.t1028
action.summary_index.attack_ID = t1028
action.summary_index.sigma_tags = attack.s0002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects usage of mimikatz through WinRM protocol by monitoring access to lsass process by wsmprovhost.exe."

[PowerShell Base64 Encoded Shellcode]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*AAAAYInlM*" (CommandLine="*OiCAAAAYInlM*" OR CommandLine="*OiJAAAAYInlM*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell Base64 Encoded Shellcode
action.summary_index.rule_description = Detects Base64 encoded Shellcode

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1027
action.summary_index.attack_ID = t1027

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects Base64 encoded Shellcode"

[Creation of a Local Hidden User Account by Registry]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*" TargetObject="*$" Image="*lsass.exe") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Creation of a Local Hidden User Account by Registry
action.summary_index.rule_description = Sysmon registry detection of a local hidden user account.

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1136.001
action.summary_index.attack_ID = t1136.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Sysmon registry detection of a local hidden user account."

[Sysmon Configuration Modification]
#Global options
disabled = false
search = `windows_evtx` (State="Stopped" OR "Sysmon config state changed") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Sysmon Configuration Modification
action.summary_index.rule_description = Someone try to hide from Sysmon

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1564
action.summary_index.attack_ID = t1564

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Someone try to hide from Sysmon"

[PowerShell SAM Copy]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*\\HarddiskVolumeShadowCopy*" CommandLine="*ystem32\\config\\sam*" (CommandLine="*Copy-Item*" OR CommandLine="*cp $_.*" OR CommandLine="*cpi $_.*" OR CommandLine="*copy $_.*" OR CommandLine="*.File]::Copy(*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell SAM Copy
action.summary_index.rule_description = Detects suspicious PowerShell scripts accessing SAM hives

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.002
action.summary_index.attack_ID = t1003.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell scripts accessing SAM hives"

[File Creation by Office Applications]
#Global options
disabled = false
search = `windows_evtx` ((Image="*winword.exe" OR Image="*excel.exe" OR Image="*powerpnt.exe") ((FileName="*.exe" OR FileName="*.dll" OR FileName="*.ocx" OR FileName="*.com" OR FileName="*.ps1" OR FileName="*.vbs" OR FileName="*.sys" OR FileName="*.bat" OR FileName="*.scr" OR FileName="*.proj") OR (FileMagicBytes="4D5A*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = File Creation by Office Applications
action.summary_index.rule_description = This rule will monitor executable and script file creation by office applications. Please add more file extensions or magic bytes to the logic of your choice.

action.summary_index.sigma_tags = attack.t1204.002
action.summary_index.attack_ID = t1204.002
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047
action.summary_index.sigma_tags = attack.t1218.010
action.summary_index.attack_ID = t1218.010
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.defense_evasion

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "This rule will monitor executable and script file creation by office applications. Please add more file extensions or magic bytes to the logic of your choice."

[Sysmon Configuration Error]
#Global options
disabled = false
search = `windows_evtx` (Description="*Failed to open service configuration with error*" OR Description="*Failed to connect to the driver to update configuration*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Sysmon Configuration Error
action.summary_index.rule_description = Someone try to hide from Sysmon

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1564
action.summary_index.attack_ID = t1564

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Someone try to hide from Sysmon"

[Quick Execution of a Series of Suspicious Commands]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*arp.exe*" OR CommandLine="*at.exe*" OR CommandLine="*attrib.exe*" OR CommandLine="*cscript.exe*" OR CommandLine="*dsquery.exe*" OR CommandLine="*hostname.exe*" OR CommandLine="*ipconfig.exe*" OR CommandLine="*mimikatz.exe*" OR CommandLine="*nbtstat.exe*" OR CommandLine="*net.exe*" OR CommandLine="*netsh.exe*" OR CommandLine="*nslookup.exe*" OR CommandLine="*ping.exe*" OR CommandLine="*quser.exe*" OR CommandLine="*qwinsta.exe*" OR CommandLine="*reg.exe*" OR CommandLine="*runas.exe*" OR CommandLine="*sc.exe*" OR CommandLine="*schtasks.exe*" OR CommandLine="*ssh.exe*" OR CommandLine="*systeminfo.exe*" OR CommandLine="*taskkill.exe*" OR CommandLine="*telnet.exe*" OR CommandLine="*tracert.exe*" OR CommandLine="*wscript.exe*" OR CommandLine="*xcopy.exe*" OR CommandLine="*pscp.exe*" OR CommandLine="*copy.exe*" OR CommandLine="*robocopy.exe*" OR CommandLine="*certutil.exe*" OR CommandLine="*vssadmin.exe*" OR CommandLine="*powershell.exe*" OR CommandLine="*wevtutil.exe*" OR CommandLine="*psexec.exe*" OR CommandLine="*bcedit.exe*" OR CommandLine="*wbadmin.exe*" OR CommandLine="*icacls.exe*" OR CommandLine="*diskpart.exe*") | eventstats count as val by Computer| search val > 5 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Quick Execution of a Series of Suspicious Commands
action.summary_index.rule_description = Detects multiple suspicious process in a limited timeframe

action.summary_index.sigma_tags = car.2013-04-002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects multiple suspicious process in a limited timeframe"

[CVE-2021-1675 Print Spooler Exploitation Filename Pattern]
#Global options
disabled = false
search = `windows_evtx` (TargetFilename="*C:\\Windows\\System32\\spool\\drivers\\x64\\3\\old\\1\\123*" OR TargetFilename="*C:\\Windows\\System32\\spool\\drivers\\x64\\3\\New\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CVE-2021-1675 Print Spooler Exploitation Filename Pattern
action.summary_index.rule_description = Detects the default filename used in PoC code against print spooler vulnerability CVE-2021-1675

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = cve.2021.1675

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the default filename used in PoC code against print spooler vulnerability CVE-2021-1675"

[WMI Event Subscription]
#Global options
disabled = false
search = `windows_evtx` (EventCode="19" OR EventCode="20" OR EventCode="21") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = WMI Event Subscription
action.summary_index.rule_description = Detects creation of WMI event subscription persistence method

action.summary_index.sigma_tags = attack.t1084
action.summary_index.attack_ID = t1084
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1546.003
action.summary_index.attack_ID = t1546.003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects creation of WMI event subscription persistence method"

[Sysinternals SDelete File Deletion]
#Global options
disabled = false
search = `windows_evtx` (TargetFilename="*.AAA" OR TargetFilename="*.ZZZ") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Sysinternals SDelete File Deletion
action.summary_index.rule_description = A General detection to trigger for the deletion of files by Sysinternals SDelete. It looks for the common name pattern used to rename files.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1070.004
action.summary_index.attack_ID = t1070.004

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "A General detection to trigger for the deletion of files by Sysinternals SDelete. It looks for the common name pattern used to rename files."

[Netcat The Powershell Version]
#Global options
disabled = false
search = `windows_evtx` (HostApplication="*powercat *" OR HostApplication="*powercat.ps1*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Netcat The Powershell Version
action.summary_index.rule_description = Adversaries may use a non-application layer protocol for communication between host and C2 server or among infected hosts within a network

action.summary_index.sigma_tags = attack.command_and_control
action.summary_index.sigma_tags = attack.t1095
action.summary_index.attack_ID = t1095

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Adversaries may use a non-application layer protocol for communication between host and C2 server or among infected hosts within a network"

[Local User Creation]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4720") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Local User Creation
action.summary_index.rule_description = Detects local user creation on windows servers, which shouldn't happen in an Active Directory environment. Apply this Sigma Use Case on your windows server logs and not on your DC logs.

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1136
action.summary_index.attack_ID = t1136
action.summary_index.sigma_tags = attack.t1136.001
action.summary_index.attack_ID = t1136.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects local user creation on windows servers, which shouldn't happen in an Active Directory environment. Apply this Sigma Use Case on your windows server logs and not on your DC logs."

[NetNTLM Downgrade Attack]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="*SYSTEM\\*" TargetObject="*ControlSet*" TargetObject="*\\Control\\Lsa*" (TargetObject="*\\lmcompatibilitylevel" OR TargetObject="*\\NtlmMinClientSec" OR TargetObject="*\\RestrictSendingNTLMTraffic")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = NetNTLM Downgrade Attack
action.summary_index.rule_description = Detects NetNTLM downgrade attack

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1089
action.summary_index.attack_ID = t1089
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001
action.summary_index.sigma_tags = attack.t1112
action.summary_index.attack_ID = t1112

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects NetNTLM downgrade attack"

[Malicious PowerShell Commandlet Names]
#Global options
disabled = false
search = `windows_evtx` (TargetFilename="*\\Invoke-DllInjection.ps1" OR TargetFilename="*\\Invoke-WmiCommand.ps1" OR TargetFilename="*\\Get-GPPPassword.ps1" OR TargetFilename="*\\Get-Keystrokes.ps1" OR TargetFilename="*\\Get-VaultCredential.ps1" OR TargetFilename="*\\Invoke-CredentialInjection.ps1" OR TargetFilename="*\\Invoke-Mimikatz.ps1" OR TargetFilename="*\\Invoke-NinjaCopy.ps1" OR TargetFilename="*\\Invoke-TokenManipulation.ps1" OR TargetFilename="*\\Out-Minidump.ps1" OR TargetFilename="*\\VolumeShadowCopyTools.ps1" OR TargetFilename="*\\Invoke-ReflectivePEInjection.ps1" OR TargetFilename="*\\Get-TimedScreenshot.ps1" OR TargetFilename="*\\Invoke-UserHunter.ps1" OR TargetFilename="*\\Find-GPOLocation.ps1" OR TargetFilename="*\\Invoke-ACLScanner.ps1" OR TargetFilename="*\\Invoke-DowngradeAccount.ps1" OR TargetFilename="*\\Get-ServiceUnquoted.ps1" OR TargetFilename="*\\Get-ServiceFilePermission.ps1" OR TargetFilename="*\\Get-ServicePermission.ps1" OR TargetFilename="*\\Invoke-ServiceAbuse.ps1" OR TargetFilename="*\\Install-ServiceBinary.ps1" OR TargetFilename="*\\Get-RegAutoLogon.ps1" OR TargetFilename="*\\Get-VulnAutoRun.ps1" OR TargetFilename="*\\Get-VulnSchTask.ps1" OR TargetFilename="*\\Get-UnattendedInstallFile.ps1" OR TargetFilename="*\\Get-WebConfig.ps1" OR TargetFilename="*\\Get-ApplicationHost.ps1" OR TargetFilename="*\\Get-RegAlwaysInstallElevated.ps1" OR TargetFilename="*\\Get-Unconstrained.ps1" OR TargetFilename="*\\Add-RegBackdoor.ps1" OR TargetFilename="*\\Add-ScrnSaveBackdoor.ps1" OR TargetFilename="*\\Gupt-Backdoor.ps1" OR TargetFilename="*\\Invoke-ADSBackdoor.ps1" OR TargetFilename="*\\Enabled-DuplicateToken.ps1" OR TargetFilename="*\\Invoke-PsUaCme.ps1" OR TargetFilename="*\\Remove-Update.ps1" OR TargetFilename="*\\Check-VM.ps1" OR TargetFilename="*\\Get-LSASecret.ps1" OR TargetFilename="*\\Get-PassHashes.ps1" OR TargetFilename="*\\Show-TargetScreen.ps1" OR TargetFilename="*\\Port-Scan.ps1" OR TargetFilename="*\\Invoke-PoshRatHttp.ps1" OR TargetFilename="*\\Invoke-PowerShellTCP.ps1" OR TargetFilename="*\\Invoke-PowerShellWMI.ps1" OR TargetFilename="*\\Add-Exfiltration.ps1" OR TargetFilename="*\\Add-Persistence.ps1" OR TargetFilename="*\\Do-Exfiltration.ps1" OR TargetFilename="*\\Start-CaptureServer.ps1" OR TargetFilename="*\\Invoke-ShellCode.ps1" OR TargetFilename="*\\Get-ChromeDump.ps1" OR TargetFilename="*\\Get-ClipboardContents.ps1" OR TargetFilename="*\\Get-FoxDump.ps1" OR TargetFilename="*\\Get-IndexedItem.ps1" OR TargetFilename="*\\Get-Screenshot.ps1" OR TargetFilename="*\\Invoke-Inveigh.ps1" OR TargetFilename="*\\Invoke-NetRipper.ps1" OR TargetFilename="*\\Invoke-EgressCheck.ps1" OR TargetFilename="*\\Invoke-PostExfil.ps1" OR TargetFilename="*\\Invoke-PSInject.ps1" OR TargetFilename="*\\Invoke-RunAs.ps1" OR TargetFilename="*\\MailRaider.ps1" OR TargetFilename="*\\New-HoneyHash.ps1" OR TargetFilename="*\\Set-MacAttribute.ps1" OR TargetFilename="*\\Invoke-DCSync.ps1" OR TargetFilename="*\\Invoke-PowerDump.ps1" OR TargetFilename="*\\Exploit-Jboss.ps1" OR TargetFilename="*\\Invoke-ThunderStruck.ps1" OR TargetFilename="*\\Invoke-VoiceTroll.ps1" OR TargetFilename="*\\Set-Wallpaper.ps1" OR TargetFilename="*\\Invoke-InveighRelay.ps1" OR TargetFilename="*\\Invoke-PsExec.ps1" OR TargetFilename="*\\Invoke-SSHCommand.ps1" OR TargetFilename="*\\Get-SecurityPackages.ps1" OR TargetFilename="*\\Install-SSP.ps1" OR TargetFilename="*\\Invoke-BackdoorLNK.ps1" OR TargetFilename="*\\PowerBreach.ps1" OR TargetFilename="*\\Get-SiteListPassword.ps1" OR TargetFilename="*\\Get-System.ps1" OR TargetFilename="*\\Invoke-BypassUAC.ps1" OR TargetFilename="*\\Invoke-Tater.ps1" OR TargetFilename="*\\Invoke-WScriptBypassUAC.ps1" OR TargetFilename="*\\PowerUp.ps1" OR TargetFilename="*\\PowerView.ps1" OR TargetFilename="*\\Get-RickAstley.ps1" OR TargetFilename="*\\Find-Fruit.ps1" OR TargetFilename="*\\HTTP-Login.ps1" OR TargetFilename="*\\Find-TrustedDocuments.ps1" OR TargetFilename="*\\Invoke-Paranoia.ps1" OR TargetFilename="*\\Invoke-WinEnum.ps1" OR TargetFilename="*\\Invoke-ARPScan.ps1" OR TargetFilename="*\\Invoke-PortScan.ps1" OR TargetFilename="*\\Invoke-ReverseDNSLookup.ps1" OR TargetFilename="*\\Invoke-SMBScanner.ps1" OR TargetFilename="*\\Invoke-Mimikittenz.ps1") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Malicious PowerShell Commandlet Names
action.summary_index.rule_description = Detects the creation of known powershell scripts for exploitation

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the creation of known powershell scripts for exploitation"

[Remote PowerShell Sessions Network Connections (WinRM)]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="5156" (DestPort="5985" OR DestPort="5986") LayerRTID="44") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Remote PowerShell Sessions Network Connections (WinRM)
action.summary_index.rule_description = Detects basic PowerShell Remoting (WinRM) by monitoring for network inbound connections to ports 5985 OR 5986

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects basic PowerShell Remoting (WinRM) by monitoring for network inbound connections to ports 5985 OR 5986"

[Password Dumper Remote Thread in LSASS]
#Global options
disabled = false
search = `windows_evtx` (TargetImage="*\\lsass.exe" StartModule="") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Password Dumper Remote Thread in LSASS
action.summary_index.rule_description = Detects password dumper activity by monitoring remote thread creation EventID 8 in combination with the lsass.exe process as TargetImage. The process in field Process is the malicious program. A single execution can lead to hundreds of events.

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.s0005
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects password dumper activity by monitoring remote thread creation EventID 8 in combination with the lsass.exe process as TargetImage. The process in field Process is the malicious program. A single execution can lead to hundreds of events."

[Suspicious Scripting in a WMI Consumer]
#Global options
disabled = false
search = `windows_evtx` ((Destination="*new-object*" Destination="*net.webclient*" Destination="*.downloadstring*") OR (Destination="*new-object*" Destination="*net.webclient*" Destination="*.downloadfile*") OR (Destination="* iex(*" OR Destination="*WScript.shell*" OR Destination="* -nop *" OR Destination="* -noprofile *" OR Destination="* -decode *" OR Destination="* -enc *") OR (Destination="*WScript.Shell*" OR Destination="*System.Security.Cryptography.FromBase64Transform*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Scripting in a WMI Consumer
action.summary_index.rule_description = Detects suspicious scripting in WMI Event Consumers

action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.005
action.summary_index.attack_ID = t1059.005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious scripting in WMI Event Consumers"

[Zip A Folder With PowerShell For Staging In Temp]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*Compress-Archive *" ScriptBlockText="* -Path *" ScriptBlockText="* -DestinationPath *" ScriptBlockText="*$env:TEMP\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Zip A Folder With PowerShell For Staging In Temp
action.summary_index.rule_description = Use living off the land tools to zip a file and stage it in the Windows temporary folder for later exfiltration

action.summary_index.sigma_tags = attack.collection
action.summary_index.sigma_tags = attack.t1074.001
action.summary_index.attack_ID = t1074.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Use living off the land tools to zip a file and stage it in the Windows temporary folder for later exfiltration"

[Windows Firewall Profile Disabled]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*Set-NetFirewallProfile*" ScriptBlockText="*-Profile*" ScriptBlockText="*-Enabled*" ScriptBlockText="*False*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Firewall Profile Disabled
action.summary_index.rule_description = Detects when a user disables the Windows Firewall via a Profile to help evade defense.

action.summary_index.sigma_tags = attack.defense_evasion

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects when a user disables the Windows Firewall via a Profile to help evade defense."

[Possible Privilege Escalation via Service Permissions Weakness]
#Global options
disabled = false
search = `windows_evtx` (IntegrityLevel="Medium" CommandLine="*ControlSet*" CommandLine="*services*" (CommandLine="*\\ImagePath*" OR CommandLine="*\\FailureCommand*" OR CommandLine="*\\ServiceDll*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Possible Privilege Escalation via Service Permissions Weakness
action.summary_index.rule_description = Detect modification of services configuration (ImagePath, FailureCommand and ServiceDLL) in registry by processes with Medium integrity level

action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1058
action.summary_index.attack_ID = t1058
action.summary_index.sigma_tags = attack.t1574.011
action.summary_index.attack_ID = t1574.011

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detect modification of services configuration (ImagePath, FailureCommand and ServiceDLL) in registry by processes with Medium integrity level"

[Multiple Users Failing to Authenticate from Single Process]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4625" LogonType="2") NOT ProcessName="-") | eventstats dc(TargetUserName) as val by ProcessName | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Multiple Users Failing to Authenticate from Single Process
action.summary_index.rule_description = Detects failed logins with multiple accounts from a single process on the system.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects failed logins with multiple accounts from a single process on the system."

[WMI Persistence - Script Event Consumer]
#Global options
disabled = false
search = `windows_evtx` (Image="C:\\WINDOWS\\system32\\wbem\\scrcons.exe" ParentImage="C:\\Windows\\System32\\svchost.exe") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = WMI Persistence - Script Event Consumer
action.summary_index.rule_description = Detects WMI script event consumers

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1546.003
action.summary_index.attack_ID = t1546.003
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects WMI script event consumers"

[Persistent Outlook Landing Pages]
#Global options
disabled = false
search = `windows_evtx` ((TargetObject="*Software\\Microsoft\\Office\\*" OR TargetObject="*Outlook\\WebView\\*") TargetObject="*URL" (TargetObject="*Calendar*" OR TargetObject="*Inbox*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Persistent Outlook Landing Pages
action.summary_index.rule_description = Detects the manipulation of persistent URLs which can be malicious

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1112
action.summary_index.attack_ID = t1112

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the manipulation of persistent URLs which can be malicious"

[Service Execution]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\net.exe" OR Image="*\\net1.exe") CommandLine="* start *") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Service Execution
action.summary_index.rule_description = Detects manual service execution (start) via system utilities.

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1035
action.summary_index.attack_ID = t1035
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects manual service execution (start) via system utilities."

[CobaltStrike Load by Rundll32]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*rundll32.exe*" CommandLine="*.dll*" CommandLine="*StartW*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CobaltStrike Load by Rundll32
action.summary_index.rule_description = Rundll32 can be use by Cobalt Strike with StartW function to load DLLs from the command line.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1218.011
action.summary_index.attack_ID = t1218.011

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Rundll32 can be use by Cobalt Strike with StartW function to load DLLs from the command line."

[Suspicious File Characteristics Due to Missing Fields]
#Global options
disabled = false
search = `windows_evtx` (Description="\?" (FileVersion="\?" OR Product="\?" OR Company="\?") Image="*\\Downloads\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious File Characteristics Due to Missing Fields
action.summary_index.rule_description = Detects Executables in the Downloads folder without FileVersion,Description,Product,Company likely created with py2exe

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.006
action.summary_index.attack_ID = t1059.006
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1064
action.summary_index.attack_ID = t1064

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects Executables in the Downloads folder without FileVersion,Description,Product,Company likely created with py2exe"

[Account Tampering - Suspicious Failed Logon Reasons]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4625" OR EventCode="4776") (Status="0xC0000072" OR Status="0xC000006F" OR Status="0xC0000070" OR Status="0xC0000413" OR Status="0xC000018C" OR Status="0xC000015B")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Account Tampering - Suspicious Failed Logon Reasons
action.summary_index.rule_description = This method uses uncommon error codes on failed logons to determine suspicious activity and tampering with accounts that have been disabled or somehow restricted.

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.t1078
action.summary_index.attack_ID = t1078

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "This method uses uncommon error codes on failed logons to determine suspicious activity and tampering with accounts that have been disabled or somehow restricted."

[Sysinternals SDelete Registry Keys]
#Global options
disabled = false
search = `windows_evtx` TargetObject="*\\Software\\Sysinternals\\SDelete*" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Sysinternals SDelete Registry Keys
action.summary_index.rule_description = A General detection to trigger for the creation or modification of .*\Software\Sysinternals\SDelete registry keys. Indicators of the use of Sysinternals SDelete tool.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1070.004
action.summary_index.attack_ID = t1070.004

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "A General detection to trigger for the creation or modification of .*\Software\Sysinternals\SDelete registry keys. Indicators of the use of Sysinternals SDelete tool."

[Remote PowerShell Session]
#Global options
disabled = false
search = `windows_evtx` (HostName="ServerRemoteHost" HostApplication="*wsmprovhost.exe*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Remote PowerShell Session
action.summary_index.rule_description = Detects remote PowerShell sessions

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.006
action.summary_index.attack_ID = t1021.006
action.summary_index.sigma_tags = attack.t1028
action.summary_index.attack_ID = t1028

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects remote PowerShell sessions"

[Non Interactive PowerShell]
#Global options
disabled = false
search = `windows_evtx` (Image="*\\powershell.exe" NOT (ParentImage="*\\explorer.exe" OR ParentImage="*\\CompatTelRunner.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Non Interactive PowerShell
action.summary_index.rule_description = Detects non-interactive PowerShell activity by looking at powershell.exe with not explorer.exe as a parent.

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects non-interactive PowerShell activity by looking at powershell.exe with not explorer.exe as a parent."

[Suspicious Run Key from Download]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\Downloads\\*" OR Image="*\\Temporary Internet Files\\Content.Outlook\\*" OR Image="*\\Local Settings\\Temporary Internet Files\\*") TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Run Key from Download
action.summary_index.rule_description = Detects the suspicious RUN keys created by software located in Download or temporary Outlook/Internet Explorer directories

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1060
action.summary_index.attack_ID = t1060
action.summary_index.sigma_tags = attack.t1547.001
action.summary_index.attack_ID = t1547.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the suspicious RUN keys created by software located in Download or temporary Outlook/Internet Explorer directories"

[Pass the Hash Activity 2]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4624" ((SubjectUserSid="S-1-0-0" LogonType="3" LogonProcessName="NtLmSsp" KeyLength="0") OR (LogonType="9" LogonProcessName="seclogo"))) NOT AccountName="ANONYMOUS LOGON") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Pass the Hash Activity 2
action.summary_index.rule_description = Detects the attack technique pass the hash which is used to move laterally inside the network

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1075
action.summary_index.attack_ID = t1075
action.summary_index.sigma_tags = attack.t1550.002
action.summary_index.attack_ID = t1550.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the attack technique pass the hash which is used to move laterally inside the network"

[Windows Defender Exclusions Added]
#Global options
disabled = false
search = `windows_evtx` (EventCode="5007" New_Value="*\\Microsoft\\Windows Defender\\Exclusions*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Defender Exclusions Added
action.summary_index.rule_description = Detects the Setting of Windows Defender Exclusions

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1089
action.summary_index.attack_ID = t1089
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the Setting of Windows Defender Exclusions"

[Created Files by Office Applications]
#Global options
disabled = false
search = `windows_evtx` ((Image="*winword.exe" OR Image="*excel.exe" OR Image="*powerpnt.exe") (TargetFileName="*.exe" OR TargetFileName="*.dll" OR TargetFileName="*.ocx" OR TargetFileName="*.com" OR TargetFileName="*.ps1" OR TargetFileName="*.vbs" OR TargetFileName="*.sys" OR TargetFileName="*.bat" OR TargetFileName="*.scr" OR TargetFileName="*.proj")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Created Files by Office Applications
action.summary_index.rule_description = This rule will monitor executable and script file creation by office applications. Please add more file extensions or magic bytes to the logic of your choice.

action.summary_index.sigma_tags = attack.t1204.002
action.summary_index.attack_ID = t1204.002
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047
action.summary_index.sigma_tags = attack.t1218.010
action.summary_index.attack_ID = t1218.010
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.defense_evasion

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "This rule will monitor executable and script file creation by office applications. Please add more file extensions or magic bytes to the logic of your choice."

[Recon Information for Export with PowerShell]
#Global options
disabled = false
search = `windows_evtx` ((ScriptBlockText="*Get-Service *" OR ScriptBlockText="*Get-ChildItem *" OR ScriptBlockText="*Get-Process *") ScriptBlockText="*> $env:TEMP\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Recon Information for Export with PowerShell
action.summary_index.rule_description = Once established within a system or network, an adversary may use automated techniques for collecting internal data

action.summary_index.sigma_tags = attack.collection
action.summary_index.sigma_tags = attack.t1119
action.summary_index.attack_ID = t1119

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Once established within a system or network, an adversary may use automated techniques for collecting internal data"

[Suspicious Reconnaissance Activity]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="net group \"domain admins\" /dom" OR CommandLine="net localgroup administrators" OR CommandLine="net group \"enterprise admins\" /dom" OR CommandLine="net accounts /dom") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Reconnaissance Activity
action.summary_index.rule_description = Detects suspicious command line activity on Windows systems

action.summary_index.sigma_tags = attack.discovery
action.summary_index.sigma_tags = attack.t1087.001
action.summary_index.attack_ID = t1087.001
action.summary_index.sigma_tags = attack.t1087.002
action.summary_index.attack_ID = t1087.002
action.summary_index.sigma_tags = attack.t1087
action.summary_index.attack_ID = t1087

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious command line activity on Windows systems"

[Valid Users Failing to Authenticate From Single Source Using Kerberos]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4771" Status="0x18") NOT TargetUserName="*$") | eventstats dc(TargetUserName) as val by IpAddress | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Valid Users Failing to Authenticate From Single Source Using Kerberos
action.summary_index.rule_description = Detects multiple failed logins with multiple valid domain accounts from a single source system using the Kerberos protocol.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects multiple failed logins with multiple valid domain accounts from a single source system using the Kerberos protocol."

[Denied Access To Remote Desktop]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4825") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Denied Access To Remote Desktop
action.summary_index.rule_description = This event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop. Often, this event can be generated by attackers when searching for available windows servers in the network.

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1076
action.summary_index.attack_ID = t1076
action.summary_index.sigma_tags = attack.t1021.001
action.summary_index.attack_ID = t1021.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "This event is generated when an authenticated user who is not allowed to log on remotely attempts to connect to this computer through Remote Desktop. Often, this event can be generated by attackers when searching for available windows servers in the network."

[Password Dumper Activity on LSASS]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4656" ProcessName="*\\lsass.exe" AccessMask="0x705" ObjectType="SAM_DOMAIN") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Password Dumper Activity on LSASS
action.summary_index.rule_description = Detects process handle on LSASS process with certain access mask and object type SAM_DOMAIN

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects process handle on LSASS process with certain access mask and object type SAM_DOMAIN"

[Removal of Potential COM Hijacking Registry Keys]
#Global options
disabled = false
search = `windows_evtx` (EventType="DeleteKey" TargetObject="*\\shell\\open\\command") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Removal of Potential COM Hijacking Registry Keys
action.summary_index.rule_description = A General detection to trigger for processes removing .*\shell\open\command registry keys. Registry keys that might have been used for COM hijacking activities.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1112
action.summary_index.attack_ID = t1112

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "A General detection to trigger for processes removing .*\shell\open\command registry keys. Registry keys that might have been used for COM hijacking activities."

[PrinterNightmare Mimimkatz Driver Name]
#Global options
disabled = false
search = `windows_evtx` (((TargetObject="*\\Control\\Print\\Environments\\Windows x64\\Drivers\\Version-3\\QMS 810\\*" OR TargetObject="*\\Control\\Print\\Environments\\Windows x64\\Drivers\\Version-3\\mimikatz*") OR (TargetObject="*legitprinter*" TargetObject="*\\Control\\Print\\Environments\\Windows*")) OR ((TargetObject="*\\Control\\Print\\Environments*" OR TargetObject="*\\CurrentVersion\\Print\\Printers*") (TargetObject="*Gentil Kiwi*" OR TargetObject="*mimikatz printer*" OR TargetObject="*Kiwi Legit Printer*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PrinterNightmare Mimimkatz Driver Name
action.summary_index.rule_description = Detects static QMS 810 and mimikatz driver name used by Mimikatz as exploited in CVE-2021-1675 and CVE-2021-34527

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = cve.2021.1675
action.summary_index.sigma_tags = cve.2021.34527

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects static QMS 810 and mimikatz driver name used by Mimikatz as exploited in CVE-2021-1675 and CVE-2021-34527"

[Net.exe Execution]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\net.exe" OR Image="*\\net1.exe") (CommandLine="* group*" OR CommandLine="* localgroup*" OR CommandLine="* user*" OR CommandLine="* view*" OR CommandLine="* share*" OR CommandLine="* accounts*" OR CommandLine="* stop *")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Net.exe Execution
action.summary_index.rule_description = Detects execution of Net.exe, whether suspicious or benign.

action.summary_index.sigma_tags = attack.discovery
action.summary_index.sigma_tags = attack.t1049
action.summary_index.attack_ID = t1049
action.summary_index.sigma_tags = attack.t1018
action.summary_index.attack_ID = t1018
action.summary_index.sigma_tags = attack.t1135
action.summary_index.attack_ID = t1135
action.summary_index.sigma_tags = attack.t1201
action.summary_index.attack_ID = t1201
action.summary_index.sigma_tags = attack.t1069.001
action.summary_index.attack_ID = t1069.001
action.summary_index.sigma_tags = attack.t1069.002
action.summary_index.attack_ID = t1069.002
action.summary_index.sigma_tags = attack.t1087.001
action.summary_index.attack_ID = t1087.001
action.summary_index.sigma_tags = attack.t1087.002
action.summary_index.attack_ID = t1087.002
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002
action.summary_index.sigma_tags = attack.t1077
action.summary_index.attack_ID = t1077
action.summary_index.sigma_tags = attack.s0039

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects execution of Net.exe, whether suspicious or benign."

[Accessing WinAPI in PowerShell for Credentials Dumping]
#Global options
disabled = false
search = `windows_evtx` (Channel="Microsoft-Windows-Sysmon/Operational" (EventCode="8" OR EventCode="10") SourceImage="*\\powershell.exe" TargetImage="*\\lsass.exe") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Accessing WinAPI in PowerShell for Credentials Dumping
action.summary_index.rule_description = Detects Accessing to lsass.exe by Powershell

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects Accessing to lsass.exe by Powershell"

[Windows PowerShell Web Request]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*Invoke-WebRequest*" OR ScriptBlockText="*iwr *" OR ScriptBlockText="*wget *" OR ScriptBlockText="*curl *" OR ScriptBlockText="*Net.WebClient*" OR ScriptBlockText="*Start-BitsTransfer*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows PowerShell Web Request
action.summary_index.rule_description = Detects the use of various web request methods (including aliases) via Windows PowerShell command

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the use of various web request methods (including aliases) via Windows PowerShell command"

[PsExec Tool Execution]
#Global options
disabled = false
search = `windows_evtx` (Channel="System" ServiceName="PSEXESVC" ((EventCode="7045" ImagePath="*\\PSEXESVC.exe") OR EventCode="7036")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PsExec Tool Execution
action.summary_index.rule_description = Detects PsExec service installation and execution events (service and Sysmon)

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1035
action.summary_index.attack_ID = t1035
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002
action.summary_index.sigma_tags = attack.s0029

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects PsExec service installation and execution events (service and Sysmon)"

[Suspicious Shells Spawn by WinRM]
#Global options
disabled = false
search = `windows_evtx` (ParentImage="*\\wsmprovhost.exe" (Image="*\\cmd.exe" OR Image="*\\sh.exe" OR Image="*\\bash.exe" OR Image="*\\powershell.exe" OR Image="*\\schtasks.exe" OR Image="*\\certutil.exe" OR Image="*\\whoami.exe" OR Image="*\\bitsadmin.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Shells Spawn by WinRM
action.summary_index.rule_description = Detects suspicious shell spawn from WinRM host process

action.summary_index.sigma_tags = attack.t1190
action.summary_index.attack_ID = t1190
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious shell spawn from WinRM host process"

[Disable or Delete Windows Eventlog]
#Global options
disabled = false
search = `windows_evtx` ((CommandLine="*logman *") (CommandLine="*stop *" OR CommandLine="*delete *") (CommandLine="*EventLog-System*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Disable or Delete Windows Eventlog
action.summary_index.rule_description = Detects command that is used to disable or delete Windows eventlog via logman Windows utility

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001
action.summary_index.sigma_tags = attack.t1070.001
action.summary_index.attack_ID = t1070.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects command that is used to disable or delete Windows eventlog via logman Windows utility"

[Windows Defender Exclusions Added]
#Global options
disabled = false
search = `windows_evtx` (EventType="SetValue" TargetObject="*\\Microsoft\\Windows Defender\\Exclusions*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Defender Exclusions Added
action.summary_index.rule_description = Detects the Setting of Windows Defender Exclusions

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1089
action.summary_index.attack_ID = t1089
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the Setting of Windows Defender Exclusions"

[Suspicious PowerShell Download]
#Global options
disabled = false
search = `windows_evtx` (ContextInfo="*System.Net.WebClient*" (ContextInfo="*.DownloadFile(*" OR ContextInfo="*.DownloadString(*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Download
action.summary_index.rule_description = Detects suspicious PowerShell download command

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell download command"

[Registry Persistence Mechanisms]
#Global options
disabled = false
search = `windows_evtx` ((TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion*") ((TargetObject="*\\Image File Execution Options\\*" TargetObject="*\\GlobalFlag*") OR (TargetObject="*SilentProcessExit\\*" TargetObject="*\\ReportingMode*") OR (TargetObject="*SilentProcessExit\\*" TargetObject="*\\MonitorProcess*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Registry Persistence Mechanisms
action.summary_index.rule_description = Detects persistence registry keys

action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1183
action.summary_index.attack_ID = t1183
action.summary_index.sigma_tags = attack.t1546.012
action.summary_index.attack_ID = t1546.012
action.summary_index.sigma_tags = car.2013-01-002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects persistence registry keys"

[Volume Shadow Copy Mount]
#Global options
disabled = false
search = `windows_evtx` (Channel="System" Provider_Name="Microsoft-Windows-Ntfs" EventCode="98" DeviceName="*HarddiskVolumeShadowCopy*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Volume Shadow Copy Mount
action.summary_index.rule_description = Detects volume shadow copy mount

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.002
action.summary_index.attack_ID = t1003.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects volume shadow copy mount"

[Remote WMI ActiveScriptEventConsumers]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4624" LogonType="3" ProcessName="*scrcons.exe") NOT TargetLogonId="0x3e7") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Remote WMI ActiveScriptEventConsumers
action.summary_index.rule_description = Detect potential adversaries leveraging WMI ActiveScriptEventConsumers remotely to move laterally in a network

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1546.003
action.summary_index.attack_ID = t1546.003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detect potential adversaries leveraging WMI ActiveScriptEventConsumers remotely to move laterally in a network"

[Scheduled Task Creation]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\schtasks.exe" CommandLine="* /create *") NOT (User="NT AUTHORITY\\SYSTEM*" OR User="AUTORITE NT\\Sys*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Scheduled Task Creation
action.summary_index.rule_description = Detects the creation of scheduled tasks in user session

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1053.005
action.summary_index.attack_ID = t1053.005
action.summary_index.sigma_tags = attack.t1053
action.summary_index.attack_ID = t1053
action.summary_index.sigma_tags = attack.s0111
action.summary_index.sigma_tags = car.2013-08-001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the creation of scheduled tasks in user session"

[Login with WMI]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4624" ProcessName="*\\WmiPrvSE.exe") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Login with WMI
action.summary_index.rule_description = Detection of logins performed with WMI

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detection of logins performed with WMI"

[Suspicious PowerShell Download]
#Global options
disabled = false
search = `windows_evtx` (HostApplication="*System.Net.WebClient*" (HostApplication="*.DownloadFile(*" OR HostApplication="*.DownloadString(*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Download
action.summary_index.rule_description = Detects suspicious PowerShell download command

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell download command"

[Accessing WinAPI in PowerShell. Code Injection.]
#Global options
disabled = false
search = `windows_evtx` SourceImage="*\\powershell.exe" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Accessing WinAPI in PowerShell. Code Injection.
action.summary_index.rule_description = Detecting Code injection with PowerShell in another process

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detecting Code injection with PowerShell in another process"

[Suspicious PowerShell Invocations - Specific]
#Global options
disabled = false
search = `windows_evtx` ((ScriptBlockText="*-nop*" ScriptBlockText="* -w *" ScriptBlockText="*hidden*" ScriptBlockText="* -c *" ScriptBlockText="*[Convert]::FromBase64String*") OR (ScriptBlockText="* -w *" ScriptBlockText="*hidden*" ScriptBlockText="*-noni*" ScriptBlockText="*-nop*" ScriptBlockText="* -c *" ScriptBlockText="*iex*" ScriptBlockText="*New-Object*") OR (ScriptBlockText="* -w *" ScriptBlockText="*hidden*" ScriptBlockText="*-ep*" ScriptBlockText="*bypass*" ScriptBlockText="*-Enc*") OR (ScriptBlockText="*powershell*" ScriptBlockText="*reg*" ScriptBlockText="*add*" ScriptBlockText="*HKCU\\software\\microsoft\\windows\\currentversion\\run*") OR (ScriptBlockText="*bypass*" ScriptBlockText="*-noprofile*" ScriptBlockText="*-windowstyle*" ScriptBlockText="*hidden*" ScriptBlockText="*new-object*" ScriptBlockText="*system.net.webclient*" ScriptBlockText="*.download*") OR (ScriptBlockText="*iex*" ScriptBlockText="*New-Object*" ScriptBlockText="*Net.WebClient*" ScriptBlockText="*.Download*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Invocations - Specific
action.summary_index.rule_description = Detects suspicious PowerShell invocation command parameters

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell invocation command parameters"

[Suspicious Encoded Scripts in a WMI Consumer]
#Global options
disabled = false
search = `windows_evtx` (Destination="*V3JpdGVQcm9jZXNzTWVtb3J5*" OR Destination="*dyaXRlUHJvY2Vzc01lbW9ye*" OR Destination="*Xcml0ZVByb2Nlc3NNZW1vcn*" OR Destination="*VGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1vZG*" OR Destination="*RoaXMgcHJvZ3JhbSBjYW5ub3QgYmUgcnVuIGluIERPUyBtb2Rl*" OR Destination="*UaGlzIHByb2dyYW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZ*" OR Destination="*VGhpcyBwcm9ncmFtIG11c3QgYmUgcnVuIHVuZGVyIFdpbjMy*" OR Destination="*RoaXMgcHJvZ3JhbSBtdXN0IGJlIHJ1biB1bmRlciBXaW4zM*" OR Destination="*UaGlzIHByb2dyYW0gbXVzdCBiZSBydW4gdW5kZXIgV2luMz*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Encoded Scripts in a WMI Consumer
action.summary_index.rule_description = Detects suspicious encoded payloads in WMI Event Consumers

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1546.003
action.summary_index.attack_ID = t1546.003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious encoded payloads in WMI Event Consumers"

[Suspect Svchost Memory Asccess]
#Global options
disabled = false
search = `windows_evtx` (TargetImage="*\\WINDOWS\\System32\\svchost.exe" GrantedAccess="0x1F3FFF" CallTrace="*UNKNOWN*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspect Svchost Memory Asccess
action.summary_index.rule_description = Detects suspect access to svchost process memory such as that used by Invoke-Phantom to kill the winRM windows event logging service.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1562.002
action.summary_index.attack_ID = t1562.002
action.summary_index.sigma_tags = attack.t1089
action.summary_index.attack_ID = t1089

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspect access to svchost process memory such as that used by Invoke-Phantom to kill the winRM windows event logging service."

[Suspicious SYSVOL Domain Group Policy Access]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*\\SYSVOL\\*" CommandLine="*\\policies\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious SYSVOL Domain Group Policy Access
action.summary_index.rule_description = Detects Access to Domain Group Policies stored in SYSVOL

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1552.006
action.summary_index.attack_ID = t1552.006
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects Access to Domain Group Policies stored in SYSVOL"

[Failed Logins with Different Accounts from Single Source System]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4776" TargetUserName="*" Workstation="*") | eventstats dc(TargetUserName) as val by Workstation | search val > 3 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Failed Logins with Different Accounts from Single Source System
action.summary_index.rule_description = Detects suspicious failed logins with different user accounts from a single source system

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1078
action.summary_index.attack_ID = t1078

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious failed logins with different user accounts from a single source system"

[WMI Persistence]
#Global options
disabled = false
search = `windows_evtx` (Channel="Microsoft-Windows-WMI-Activity/Operational" ((EventCode="5861" ("ActiveScriptEventConsumer" OR "CommandLineEventConsumer" OR "CommandLineTemplate")) OR EventCode="5859")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = WMI Persistence
action.summary_index.rule_description = Detects suspicious WMI event filter and command line event consumer based on WMI and Security Logs.

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1084
action.summary_index.attack_ID = t1084
action.summary_index.sigma_tags = attack.t1546.003
action.summary_index.attack_ID = t1546.003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious WMI event filter and command line event consumer based on WMI and Security Logs."

[Valid Users Failing to Authenticate from Single Source Using NTLM]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4776" Status="*0xC000006A") NOT TargetUserName="*$") | eventstats dc(TargetUserName) as val by Workstation | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Valid Users Failing to Authenticate from Single Source Using NTLM
action.summary_index.rule_description = Detects failed logins with multiple valid domain accounts from a single source system using the NTLM protocol.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects failed logins with multiple valid domain accounts from a single source system using the NTLM protocol."

[Invalid Users Failing To Authenticate From Single Source Using NTLM]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4776" Status="*0xC0000064") NOT TargetUserName="*$") | eventstats dc(TargetUserName) as val by Workstation | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Invalid Users Failing To Authenticate From Single Source Using NTLM
action.summary_index.rule_description = Detects failed logins with multiple invalid domain accounts from a single source system using the NTLM protocol.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects failed logins with multiple invalid domain accounts from a single source system using the NTLM protocol."

[Disabled Users Failing To Authenticate From Source Using Kerberos]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4768" Status="0x12") NOT TargetUserName="*$") | eventstats dc(TargetUserName) as val by IpAddress | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Disabled Users Failing To Authenticate From Source Using Kerberos
action.summary_index.rule_description = Detects failed logins with multiple disabled domain accounts from a single source system using the Kerberos protocol.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects failed logins with multiple disabled domain accounts from a single source system using the Kerberos protocol."

[Path To Screensaver Binary Modified]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="*\\Control Panel\\Desktop\\SCRNSAVE.EXE" NOT (Image="*\\rundll32.exe" OR Image="*\\explorer.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Path To Screensaver Binary Modified
action.summary_index.rule_description = Detects value modification of registry key containing path to binary used as screensaver.

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1546.002
action.summary_index.attack_ID = t1546.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects value modification of registry key containing path to binary used as screensaver."

[Prefetch File Deletion]
#Global options
disabled = false
search = `windows_evtx` ((TargetFilename="C:\\Windows\\Prefetch\\*" TargetFilename="*.pf") NOT (Image="C:\\windows\\system32\\svchost.exe" User="NT AUTHORITY\\SYSTEM")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Prefetch File Deletion
action.summary_index.rule_description = Detects the deletion of a prefetch file (AntiForensic)

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1070.004
action.summary_index.attack_ID = t1070.004

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the deletion of a prefetch file (AntiForensic)"

[Powershell Timestomp]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*.CreationTime =*" OR ScriptBlockText="*.LastWriteTime =*" OR ScriptBlockText="*.LastAccessTime =*" OR ScriptBlockText="*[IO.File]::SetCreationTime*" OR ScriptBlockText="*[IO.File]::SetLastAccessTime*" OR ScriptBlockText="*[IO.File]::SetLastWriteTime*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Powershell Timestomp
action.summary_index.rule_description = Adversaries may modify file time attributes to hide new or changes to existing files. Timestomping is a technique that modifies the timestamps of a file (the modify, access, create, and change times), often to mimic files that are in the same folder.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1070.006
action.summary_index.attack_ID = t1070.006

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Adversaries may modify file time attributes to hide new or changes to existing files. Timestomping is a technique that modifies the timestamps of a file (the modify, access, create, and change times), often to mimic files that are in the same folder."

[LSASS Memory Dumping]
#Global options
disabled = false
search = `windows_evtx` (((CommandLine="*lsass*" CommandLine="*.dmp*") NOT Image="*\\werfault.exe") OR (Image="*\\procdump*" Image="*.exe" CommandLine="*lsass*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = LSASS Memory Dumping
action.summary_index.rule_description = Detect creation of dump files containing the memory space of lsass.exe, which contains sensitive credentials. Identifies usage of Sysinternals procdump.exe to export the memory space of lsass.exe which contains sensitive credentials.

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detect creation of dump files containing the memory space of lsass.exe, which contains sensitive credentials. Identifies usage of Sysinternals procdump.exe to export the memory space of lsass.exe which contains sensitive credentials."

[Meterpreter or Cobalt Strike Getsystem Service Installation]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4697" ((ImagePath="*cmd*" ImagePath="*/c*" ImagePath="*echo*" ImagePath="*\\pipe\\*") OR (ImagePath="*%COMSPEC%*" ImagePath="*/c*" ImagePath="*echo*" ImagePath="*\\pipe\\*") OR (ImagePath="*cmd.exe*" ImagePath="*/c*" ImagePath="*echo*" ImagePath="*\\pipe\\*") OR (ImagePath="*rundll32*" ImagePath="*.dll,a*" ImagePath="*/p:*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Meterpreter or Cobalt Strike Getsystem Service Installation
action.summary_index.rule_description = Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service installation

action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1134
action.summary_index.attack_ID = t1134
action.summary_index.sigma_tags = attack.t1134.001
action.summary_index.attack_ID = t1134.001
action.summary_index.sigma_tags = attack.t1134.002
action.summary_index.attack_ID = t1134.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service installation"

[Suspicious Service Installed]
#Global options
disabled = false
search = `windows_evtx` (((TargetObject="HKLM\\System\\CurrentControlSet\\Services\\NalDrv\\ImagePath" OR TargetObject="HKLM\\System\\CurrentControlSet\\Services\\PROCEXP152\\ImagePath") NOT (Image="*\\procexp64.exe" OR Image="*\\procexp.exe" OR Image="*\\procmon64.exe" OR Image="*\\procmon.exe")) NOT (Details="*\\WINDOWS\\system32\\Drivers\\PROCEXP152.SYS*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Service Installed
action.summary_index.rule_description = Detects installation of NalDrv or PROCEXP152 services via registry-keys to non-system32 folders. Both services are used in the tool Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs), which uses KDU (https://github.com/hfiref0x/KDU)

action.summary_index.sigma_tags = attack.t1089
action.summary_index.attack_ID = t1089
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001
action.summary_index.sigma_tags = attack.defense_evasion

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects installation of NalDrv or PROCEXP152 services via registry-keys to non-system32 folders. Both services are used in the tool Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs), which uses KDU (https://github.com/hfiref0x/KDU)"

[Suspicious Script Execution From Temp Folder]
#Global options
disabled = false
search = `windows_evtx` (((Image="*\\powershell.exe" OR Image="*\\mshta.exe" OR Image="*\\wscript.exe" OR Image="*\\cscript.exe") (CommandLine="*\\Windows\\Temp*" OR CommandLine="*\\Temporary Internet*" OR CommandLine="*\\AppData\\Local\\Temp*" OR CommandLine="*\\AppData\\Roaming\\Temp*" OR CommandLine="*%TEMP%*" OR CommandLine="*%TMP%*" OR CommandLine="*%LocalAppData%\\Temp*")) NOT (CommandLine="* >*" OR CommandLine="*Out-File*" OR CommandLine="*ConvertTo-Json*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Script Execution From Temp Folder
action.summary_index.rule_description = Detects a suspicious script executions from temporary folder

action.summary_index.sigma_tags = attack.execution

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a suspicious script executions from temporary folder"

[Admin User Remote Logon]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4624" LogonType="10" AuthenticationPackageName="Negotiate" TargetUserName="Admin*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Admin User Remote Logon
action.summary_index.rule_description = Detect remote login by Administrator user (depending on internal pattern).

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1078
action.summary_index.attack_ID = t1078
action.summary_index.sigma_tags = attack.t1078.001
action.summary_index.attack_ID = t1078.001
action.summary_index.sigma_tags = attack.t1078.002
action.summary_index.attack_ID = t1078.002
action.summary_index.sigma_tags = attack.t1078.003
action.summary_index.attack_ID = t1078.003
action.summary_index.sigma_tags = car.2016-04-005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detect remote login by Administrator user (depending on internal pattern)."

[LSASS Memory Dump]
#Global options
disabled = false
search = `windows_evtx` (TargetImage="*\\lsass.exe" GrantedAccess="0x1fffff" (CallTrace="*dbghelp.dll*" OR CallTrace="*dbgcore.dll*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = LSASS Memory Dump
action.summary_index.rule_description = Detects process LSASS memory dump using procdump or taskmgr based on the CallTrace pointing to dbghelp.dll or dbgcore.dll for win10

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.001
action.summary_index.attack_ID = t1003.001
action.summary_index.sigma_tags = attack.t1003
action.summary_index.attack_ID = t1003
action.summary_index.sigma_tags = attack.s0002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects process LSASS memory dump using procdump or taskmgr based on the CallTrace pointing to dbghelp.dll or dbgcore.dll for win10"

[Recon Information for Export with Command Prompt]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\tree.com" OR Image="*\\WMIC.exe" OR Image="*\\doskey.exe" OR Image="*\\sc.exe") ParentCommandLine="* > %TEMP%\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Recon Information for Export with Command Prompt
action.summary_index.rule_description = Once established within a system or network, an adversary may use automated techniques for collecting internal data.

action.summary_index.sigma_tags = attack.collection
action.summary_index.sigma_tags = attack.t1119
action.summary_index.attack_ID = t1119

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Once established within a system or network, an adversary may use automated techniques for collecting internal data."

[PowerShell as a Service in Registry]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="*\\Services\\*" TargetObject="*\\ImagePath" (Details="*powershell*" OR Details="*pwsh*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell as a Service in Registry
action.summary_index.rule_description = Detects that a powershell code is written to the registry as a service.

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects that a powershell code is written to the registry as a service."

[Powershell Detect Virtualization Environment]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*Get-WmiObject*" (ScriptBlockText="*MSAcpi_ThermalZoneTemperature*" OR ScriptBlockText="*Win32_ComputerSystem*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Powershell Detect Virtualization Environment
action.summary_index.rule_description = Adversaries may employ various system checks to detect and avoid virtualization and analysis environments. This may include changing behaviors based on the results of checks for the presence of artifacts indicative of a virtual machine environment (VME) or sandbox

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1497.001
action.summary_index.attack_ID = t1497.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Adversaries may employ various system checks to detect and avoid virtualization and analysis environments. This may include changing behaviors based on the results of checks for the presence of artifacts indicative of a virtual machine environment (VME) or sandbox"

[Impacket Lateralization Detection]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*cmd.exe*" CommandLine="*&1*" (((ParentImage="*\\wmiprvse.exe" OR ParentImage="*\\mmc.exe" OR ParentImage="*\\explorer.exe" OR ParentImage="*\\services.exe") CommandLine="*/Q*" CommandLine="*/c*" CommandLine="*\\\\127.0.0.1\\*") OR ((ParentCommandLine="*svchost.exe -k netsvcs*" OR ParentCommandLine="*taskeng.exe*") CommandLine="*/C*" CommandLine="*Windows\\Temp\\*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Impacket Lateralization Detection
action.summary_index.rule_description = Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1047
action.summary_index.attack_ID = t1047
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1175
action.summary_index.attack_ID = t1175
action.summary_index.sigma_tags = attack.t1021.003
action.summary_index.attack_ID = t1021.003
action.summary_index.sigma_tags = attack.t1021
action.summary_index.attack_ID = t1021

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework"

[Shells Spawned by Web Servers]
#Global options
disabled = false
search = `windows_evtx` ((ParentImage="*\\w3wp.exe" OR ParentImage="*\\httpd.exe" OR ParentImage="*\\nginx.exe" OR ParentImage="*\\php-cgi.exe" OR ParentImage="*\\tomcat.exe" OR ParentImage="*\\UMWorkerProcess.exe") (Image="*\\cmd.exe" OR Image="*\\sh.exe" OR Image="*\\bash.exe" OR Image="*\\powershell.exe" OR Image="*\\bitsadmin.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Shells Spawned by Web Servers
action.summary_index.rule_description = Web servers that spawn shell processes could be the result of a successfully placed web shell or an other attack

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1505.003
action.summary_index.attack_ID = t1505.003
action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = attack.t1190
action.summary_index.attack_ID = t1190

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Web servers that spawn shell processes could be the result of a successfully placed web shell or an other attack"

[Suspicious Service Binary Directory]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\Users\\Public\\*" OR Image="*\\$Recycle.bin*" OR Image="*\\Users\\All Users\\*" OR Image="*\\Users\\Default\\*" OR Image="*\\Users\\Contacts\\*" OR Image="*\\Users\\Searches\\*" OR Image="*C:\\Perflogs\\*" OR Image="*\\config\\systemprofile\\*" OR Image="*\\Windows\\Fonts\\*" OR Image="*\\Windows\\IME\\*" OR Image="*\\Windows\\addins\\*") (ParentImage="*\\services.exe" OR ParentImage="*\\svchost.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Service Binary Directory
action.summary_index.rule_description = Detects a service binary running in a suspicious directory

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1202
action.summary_index.attack_ID = t1202

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a service binary running in a suspicious directory"

[PowerShell Create Local User]
#Global options
disabled = false
search = `windows_evtx` ScriptBlockText="*New-LocalUser*" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell Create Local User
action.summary_index.rule_description = Detects creation of a local user via PowerShell

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1136.001
action.summary_index.attack_ID = t1136.001
action.summary_index.sigma_tags = attack.t1136
action.summary_index.attack_ID = t1136

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects creation of a local user via PowerShell"

[Registry Persistence via Explorer Run Key]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run" ((Details="C:\\Windows\\Temp\\*" OR Details="C:\\ProgramData\\*" OR Details="C:\\$Recycle.bin\\*" OR Details="C:\\Temp\\*" OR Details="C:\\Users\\Public\\*" OR Details="C:\\Users\\Default\\*") OR (Details="*\\AppData\\*"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Registry Persistence via Explorer Run Key
action.summary_index.rule_description = Detects a possible persistence mechanism using RUN key for Windows Explorer and pointing to a suspicious folder

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1060
action.summary_index.attack_ID = t1060
action.summary_index.sigma_tags = attack.t1547.001
action.summary_index.attack_ID = t1547.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a possible persistence mechanism using RUN key for Windows Explorer and pointing to a suspicious folder"

[Logon Scripts (UserInitMprLogonScript) Registry]
#Global options
disabled = false
search = `windows_evtx` TargetObject="*UserInitMprLogonScript*" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Logon Scripts (UserInitMprLogonScript) Registry
action.summary_index.rule_description = Detects creation or execution of UserInitMprLogonScript persistence method

action.summary_index.sigma_tags = attack.t1037
action.summary_index.attack_ID = t1037
action.summary_index.sigma_tags = attack.t1037.001
action.summary_index.attack_ID = t1037.001
action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.lateral_movement

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects creation or execution of UserInitMprLogonScript persistence method"

[PowerShell DownloadFile]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*powershell*" CommandLine="*.DownloadFile*" CommandLine="*System.Net.WebClient*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell DownloadFile
action.summary_index.rule_description = Detects the execution of powershell, a WebClient object creation and the invocation of DownloadFile in a single command line

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.command_and_control
action.summary_index.sigma_tags = attack.t1104
action.summary_index.attack_ID = t1104
action.summary_index.sigma_tags = attack.t1105
action.summary_index.attack_ID = t1105

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the execution of powershell, a WebClient object creation and the invocation of DownloadFile in a single command line"

[Multiple Users Remotely Failing To Authenticate From Single Source]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="4625" LogonType="3") NOT IpAddress="-") | eventstats dc(TargetUserName) as val by IpAddress | search val > 10 | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Multiple Users Remotely Failing To Authenticate From Single Source
action.summary_index.rule_description = Detects a source system failing to authenticate against a remote host with multiple users.

action.summary_index.sigma_tags = attack.t1110.003
action.summary_index.attack_ID = t1110.003
action.summary_index.sigma_tags = attack.initial_access
action.summary_index.sigma_tags = attack.privilege_escalation

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a source system failing to authenticate against a remote host with multiple users."

[Suspicious New Printer Ports in Registry (CVE-2020-1048)]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Ports*" (Details="*.dll*" OR Details="*.exe*" OR Details="*.bat*" OR Details="*.com*" OR Details="*C:*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious New Printer Ports in Registry (CVE-2020-1048)
action.summary_index.rule_description = Detects a new and suspicious printer port creation in Registry that could be an attempt to exploit CVE-2020-1048

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1112
action.summary_index.attack_ID = t1112

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a new and suspicious printer port creation in Registry that could be an attempt to exploit CVE-2020-1048"

[RDP over Reverse SSH Tunnel WFP]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="5156" ((SourcePort="3389" (DestAddress="127.*" OR DestAddress="::1")) OR (DestPort="3389" (SourceAddress="127.*" OR SourceAddress="::1")))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = RDP over Reverse SSH Tunnel WFP
action.summary_index.rule_description = Detects svchost hosting RDP termsvcs communicating with the loopback address

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.command_and_control
action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1076
action.summary_index.attack_ID = t1076
action.summary_index.sigma_tags = attack.t1090
action.summary_index.attack_ID = t1090
action.summary_index.sigma_tags = attack.t1090.001
action.summary_index.attack_ID = t1090.001
action.summary_index.sigma_tags = attack.t1090.002
action.summary_index.attack_ID = t1090.002
action.summary_index.sigma_tags = attack.t1021.001
action.summary_index.attack_ID = t1021.001
action.summary_index.sigma_tags = car.2013-07-002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects svchost hosting RDP termsvcs communicating with the loopback address"

[Stop Windows Service]
#Global options
disabled = false
search = `windows_evtx` ((Image="*\\sc.exe" OR Image="*\\net.exe" OR Image="*\\net1.exe") CommandLine="*stop*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Stop Windows Service
action.summary_index.rule_description = Detects a windows service to be stopped

action.summary_index.sigma_tags = attack.impact
action.summary_index.sigma_tags = attack.t1489
action.summary_index.attack_ID = t1489

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a windows service to be stopped"

[Windows Defender Real-Time Protection Disabled]
#Global options
disabled = false
search = `windows_evtx` (EventType="SetValue" (((TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableBehaviorMonitoring" OR TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableIOAVProtection" OR TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableOnAccessProtection" OR TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableRealtimeMonitoring" OR TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-Time Protection\\DisableScanOnRealtimeEnable" OR TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\DisableBlockAtFirstSeen") Details="DWORD (0x00000001)") OR ((TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\SpynetReporting" OR TargetObject="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\SpyNet\\SubmitSamplesConsent") Details="DWORD (0x00000000)"))) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Defender Real-Time Protection Disabled
action.summary_index.rule_description = Detects disabling Windows Defender Real-Time Protection by modifying registry

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects disabling Windows Defender Real-Time Protection by modifying registry"

[Tamper Windows Defender]
#Global options
disabled = false
search = `windows_evtx` (HostApplication="*Set-MpPreference*" (HostApplication="*-DisableRealtimeMonitoring 1*" OR HostApplication="*-DisableBehaviorMonitoring 1*" OR HostApplication="*-DisableScriptScanning 1*" OR HostApplication="*-DisableBlockAtFirstSeen 1*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Tamper Windows Defender
action.summary_index.rule_description = Attempting to disable scheduled scanning and other parts of windows defender atp.

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.t1562.001
action.summary_index.attack_ID = t1562.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Attempting to disable scheduled scanning and other parts of windows defender atp."

[Pass the Hash Activity]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" ((EventCode="4624" OR EventCode="4625") LogonType="3" LogonProcessName="NtLmSsp" WorkstationName="%Workstations%" Computer="%Workstations%") NOT AccountName="ANONYMOUS LOGON") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Pass the Hash Activity
action.summary_index.rule_description = Detects the attack technique pass the hash which is used to move laterally inside the network

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1075
action.summary_index.attack_ID = t1075
action.summary_index.sigma_tags = car.2016-04-004
action.summary_index.sigma_tags = attack.t1550.002
action.summary_index.attack_ID = t1550.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the attack technique pass the hash which is used to move laterally inside the network"

[Suspicious PowerShell Invocations - Generic]
#Global options
disabled = false
search = `windows_evtx` ((ScriptBlockText="* -enc *" OR ScriptBlockText="* -EncodedCommand *") (ScriptBlockText="* -w hidden *" OR ScriptBlockText="* -window hidden *" OR ScriptBlockText="* -windowstyle hidden *") (ScriptBlockText="* -noni *" OR ScriptBlockText="* -noninteractive *")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious PowerShell Invocations - Generic
action.summary_index.rule_description = Detects suspicious PowerShell invocation command parameters

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects suspicious PowerShell invocation command parameters"

[Volume Shadow Copy Service Keys]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="*System\\CurrentControlSet\\Services\\VSS*" NOT TargetObject="*System\\CurrentControlSet\\Services\\VSS\\Start*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Volume Shadow Copy Service Keys
action.summary_index.rule_description = Detects the volume shadow copy service initialization and processing. Registry keys such as HKLM\\System\\CurrentControlSet\\Services\\VSS\\Diag\\VolSnap\\Volume are captured.

action.summary_index.sigma_tags = attack.credential_access
action.summary_index.sigma_tags = attack.t1003.002
action.summary_index.attack_ID = t1003.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the volume shadow copy service initialization and processing. Registry keys such as HKLM\\System\\CurrentControlSet\\Services\\VSS\\Diag\\VolSnap\\Volume are captured."

[PortProxy Registry Key]
#Global options
disabled = false
search = `windows_evtx` TargetObject="HKLM\\SYSTEM\\CurrentControlSet\\Services\\PortProxy\\v4tov4\\tcp" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PortProxy Registry Key
action.summary_index.rule_description = Detects the modification of PortProxy registry key which is used for port forwarding. For command execution see rule win_netsh_port_fwd.yml.

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.command_and_control
action.summary_index.sigma_tags = attack.t1090
action.summary_index.attack_ID = t1090

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the modification of PortProxy registry key which is used for port forwarding. For command execution see rule win_netsh_port_fwd.yml."

[New TaskCache Entry]
#Global options
disabled = false
search = `windows_evtx` (EventType="SetValue" TargetObject="*SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = New TaskCache Entry
action.summary_index.rule_description = Monitor the creation of a new key under 'TaskCache' when a new scheduled task is registered

action.summary_index.sigma_tags = attack.persistence
action.summary_index.sigma_tags = attack.t1053
action.summary_index.attack_ID = t1053
action.summary_index.sigma_tags = attack.t1053.005
action.summary_index.attack_ID = t1053.005

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Monitor the creation of a new key under 'TaskCache' when a new scheduled task is registered"

[CobaltStrike Process Patterns]
#Global options
disabled = false
search = `windows_evtx` ((CommandLine="*\\cmd.exe /C whoami*" ParentImage="C:\\Temp*") OR (CommandLine="*conhost.exe 0xffffffff -ForceV1*" (ParentCommandLine="*/C whoami*" OR ParentCommandLine="*cmd.exe /C echo*" OR ParentCommandLine="* > \\.\\pipe*")) OR ((CommandLine="*cmd.exe /c echo*" OR CommandLine="*> \\.\\pipe*" OR CommandLine="*\\whoami.exe*") ParentImage="*\\dllhost.exe") OR (Image="*\\cmd.exe" ParentImage="*\\runonce.exe" ParentCommandLine="*\\runonce.exe")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = CobaltStrike Process Patterns
action.summary_index.rule_description = Detects process patterns found in Cobalt Strike beacon activity (see reference for more details)

action.summary_index.sigma_tags = attack.execution

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects process patterns found in Cobalt Strike beacon activity (see reference for more details)"

[Successful Overpass the Hash Attempt]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" EventCode="4624" LogonType="9" LogonProcessName="seclogo" AuthenticationPackageName="Negotiate") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Successful Overpass the Hash Attempt
action.summary_index.rule_description = Detects successful logon with logon type 9 (NewCredentials) which matches the Overpass the Hash behavior of e.g Mimikatz's sekurlsa::pth module.

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1075
action.summary_index.attack_ID = t1075
action.summary_index.sigma_tags = attack.s0002
action.summary_index.sigma_tags = attack.t1550.002
action.summary_index.attack_ID = t1550.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects successful logon with logon type 9 (NewCredentials) which matches the Overpass the Hash behavior of e.g Mimikatz's sekurlsa::pth module."

[PowerShell Rundll32 Remote Thread Creation]
#Global options
disabled = false
search = `windows_evtx` (EventCode="8" SourceImage="*\\powershell.exe" TargetImage="*\\rundll32.exe") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell Rundll32 Remote Thread Creation
action.summary_index.rule_description = Detects PowerShell remote thread creation in Rundll32.exe

action.summary_index.sigma_tags = attack.defense_evasion
action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1085
action.summary_index.attack_ID = t1085
action.summary_index.sigma_tags = attack.t1218.011
action.summary_index.attack_ID = t1218.011
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects PowerShell remote thread creation in Rundll32.exe"

[Windows Suspicious Use Of Web Request in CommandLine]
#Global options
disabled = false
search = `windows_evtx` (CommandLine="*Invoke-WebRequest*" OR CommandLine="*iwr *" OR CommandLine="*wget *" OR CommandLine="*curl *" OR CommandLine="*Net.WebClient*" OR CommandLine="*Start-BitsTransfer*") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Windows Suspicious Use Of Web Request in CommandLine
action.summary_index.rule_description = Detects the use of various web request with commandline tools or Windows PowerShell command,methods (including aliases)

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1059.001
action.summary_index.attack_ID = t1059.001
action.summary_index.sigma_tags = attack.t1086
action.summary_index.attack_ID = t1086

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects the use of various web request with commandline tools or Windows PowerShell command,methods (including aliases)"

[PowerShell Writing Startup Shortcuts]
#Global options
disabled = false
search = `windows_evtx` (Image="*\\powershell.exe" TargetFilename="*\\start menu\\programs\\startup\\*" TargetFilename="*.lnk") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PowerShell Writing Startup Shortcuts
action.summary_index.rule_description = Attempts to detect PowerShell writing startup shortcuts. This procedure was highlighted in Red Canary Intel Insights Oct. 2021, "We frequently observe adversaries using PowerShell to write malicious .lnk files into the startup directory to establish persistence. Accordingly, this detection opportunity is likely to identify persistence mechanisms in multiple threats. In the context of Yellow Cockatoo, this persistence mechanism eventually launches the command-line script that leads to the installation of a malicious DLL"

action.summary_index.sigma_tags = attack.registry_run_keys_/_startup_folder
action.summary_index.sigma_tags = attack.t1547.001
action.summary_index.attack_ID = t1547.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Attempts to detect PowerShell writing startup shortcuts. This procedure was highlighted in Red Canary Intel Insights Oct. 2021, "We frequently observe adversaries using PowerShell to write malicious .lnk files into the startup directory to establish persistence. Accordingly, this detection opportunity is likely to identify persistence mechanisms in multiple threats. In the context of Yellow Cockatoo, this persistence mechanism eventually launches the command-line script that leads to the installation of a malicious DLL""

[Access to ADMIN$ Share]
#Global options
disabled = false
search = `windows_evtx` (Channel="Security" (EventCode="5140" ShareName="Admin$") NOT SubjectUserName="*$") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Access to ADMIN$ Share
action.summary_index.rule_description = Detects access to $ADMIN share

action.summary_index.sigma_tags = attack.lateral_movement
action.summary_index.sigma_tags = attack.t1077
action.summary_index.attack_ID = t1077
action.summary_index.sigma_tags = attack.t1021.002
action.summary_index.attack_ID = t1021.002

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects access to $ADMIN share"

[PsExec Tool Execution]
#Global options
disabled = false
search = `windows_evtx` TargetFilename="*\\PSEXESVC.exe" | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = PsExec Tool Execution
action.summary_index.rule_description = Detects PsExec service installation and execution events (service and Sysmon)

action.summary_index.sigma_tags = attack.execution
action.summary_index.sigma_tags = attack.t1035
action.summary_index.attack_ID = t1035
action.summary_index.sigma_tags = attack.t1569.002
action.summary_index.attack_ID = t1569.002
action.summary_index.sigma_tags = attack.s0029

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects PsExec service installation and execution events (service and Sysmon)"

[Suspicious Printer Driver Empty Manufacturer]
#Global options
disabled = false
search = `windows_evtx` (TargetObject="*\\Control\\Print\\Environments\\Windows x64\\Drivers*" TargetObject="*\\Manufacturer*" Details="(Empty)") | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Suspicious Printer Driver Empty Manufacturer
action.summary_index.rule_description = Detects a suspicious printer driver installation with an empty Manufacturer value

action.summary_index.sigma_tags = attack.privilege_escalation
action.summary_index.sigma_tags = cve.2021.1675

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Detects a suspicious printer driver installation with an empty Manufacturer value"

[Powershell Keylogging]
#Global options
disabled = false
search = `windows_evtx` (ScriptBlockText="*Get-Keystrokes*" OR (ScriptBlockText="*Get-ProcAddress user32.dll GetAsyncKeyState*" ScriptBlockText="*Get-ProcAddress user32.dll GetForegroundWindow*")) | stats values(*) AS * by _time 

#Scheduling options
enableSched = true
cron_schedule = */30 * * * *
allow_skew = 50%
schedule_window = auto

#Notification options
counttype = number of events
relation = greater than
quantity = 0

#Settings for summary index action
action.summary_index = true
action.summary_index._name = chouchen-sigma-hunting
action.summary_index.rule_title = Powershell Keylogging
action.summary_index.rule_description = Adversaries may log user keystrokes to intercept credentials as the user types them.

action.summary_index.sigma_tags = attack.collection
action.summary_index.sigma_tags = attack.t1056.001
action.summary_index.attack_ID = t1056.001

#dispatch search options
dispatch.earliest_time = -30m
dispatch.latest_time = now

#alert settings
alert.suppress = false
alert.severity = 4
alert.track = true
alert.expires = 24h

#UI-specific settings
request.ui_dispatch_app = TA-hydromel
request.ui_dispatch_view = search
description = "Adversaries may log user keystrokes to intercept credentials as the user types them."
